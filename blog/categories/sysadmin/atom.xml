<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: sysadmin | Core dump overflow]]></title>
  <link href="http://chousensha.github.io/blog/categories/sysadmin/atom.xml" rel="self"/>
  <link href="http://chousensha.github.io/"/>
  <updated>2017-04-19T07:48:14-04:00</updated>
  <id>http://chousensha.github.io/</id>
  <author>
    <name><![CDATA[chousensha]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[DHCP server on CentOS]]></title>
    <link href="http://chousensha.github.io/blog/2017/04/13/dhcp-server-on-centos/"/>
    <updated>2017-04-13T13:59:25-04:00</updated>
    <id>http://chousensha.github.io/blog/2017/04/13/dhcp-server-on-centos</id>
    <content type="html"><![CDATA[<p>In this post I will continue the series on configuring various servers on the CentOS 7 distribution. Let&rsquo;s see how we can get a DHCP server up and running!</p>

<!-- more -->


<h2>Installing DHCP server</h2>

<p>First, we need to intall the server component, which can be done with the <code>yum install dhcp</code> command:</p>

<h1>``` plain</h1>

<h1> Package                       Arch                            Version                                           Repository                     Size</h1>

<p>Installing:
 dhcp                          x86_64                          12:4.2.5-47.el7.centos                            base                          511 k</p>

<h1>Transaction Summary</h1>

<p>Install  1 Package</p>

<p>Total download size: 511 k
Installed size: 1.4 M
Is this ok [y/d/N]: y
Downloading packages:
dhcp-4.2.5-47.el7.centos.x86_64.rpm                                                                                           | 511 kB  00:00:00   <br/>
Running transaction check
Running transaction test
Transaction test succeeded
Running transaction
  Installing : 12:dhcp-4.2.5-47.el7.centos.x86_64                                                                                                1/1
  Verifying  : 12:dhcp-4.2.5-47.el7.centos.x86_64                                                                                                1/1</p>

<p>Installed:
  dhcp.x86_64 12:4.2.5-47.el7.centos</p>

<p>Complete!
```</p>

<p>We now have a <code>/etc/dhcp/dhcpd.conf</code> file for configuring the server. There isn&rsquo;t much in it to start with, except pointers to the <code>dhcpd.conf</code> man page and a sample config file in <code>/usr/share/doc/dhcp*/dhcpd.conf.example</code>:</p>

<p>``` plain</p>

<h1>dhcpd.conf</h1>

<p>#</p>

<h1>Sample configuration file for ISC dhcpd</h1>

<p>#</p>

<h1>option definitions common to all supported networks&hellip;</h1>

<p>option domain-name &ldquo;example.org&rdquo;;
option domain-name-servers ns1.example.org, ns2.example.org;</p>

<p>default-lease-time 600;
max-lease-time 7200;</p>

<h1>Use this to enble / disable dynamic dns updates globally.</h1>

<h1>ddns-update-style none;</h1>

<h1>If this DHCP server is the official DHCP server for the local</h1>

<h1>network, the authoritative directive should be uncommented.</h1>

<h1>authoritative;</h1>

<h1>Use this to send dhcp log messages to a different log file (you also</h1>

<h1>have to hack syslog.conf to complete the redirection).</h1>

<p>log-facility local7;</p>

<h1>No service will be given on this subnet, but declaring it helps the</h1>

<h1>DHCP server to understand the network topology.</h1>

<p>subnet 10.152.187.0 netmask 255.255.255.0 {
}</p>

<h1>This is a very basic subnet declaration.</h1>

<p>subnet 10.254.239.0 netmask 255.255.255.224 {
  range 10.254.239.10 10.254.239.20;
  option routers rtr-239-0-1.example.org, rtr-239-0-2.example.org;
}</p>

<h1>This declaration allows BOOTP clients to get dynamic addresses,</h1>

<h1>which we don&rsquo;t really recommend.</h1>

<p>subnet 10.254.239.32 netmask 255.255.255.224 {
  range dynamic-bootp 10.254.239.40 10.254.239.60;
  option broadcast-address 10.254.239.31;
  option routers rtr-239-32-1.example.org;
}</p>

<h1>A slightly different configuration for an internal subnet.</h1>

<p>subnet 10.5.5.0 netmask 255.255.255.224 {
  range 10.5.5.26 10.5.5.30;
  option domain-name-servers ns1.internal.example.org;
  option domain-name &ldquo;internal.example.org&rdquo;;
  option routers 10.5.5.1;
  option broadcast-address 10.5.5.31;
  default-lease-time 600;
  max-lease-time 7200;
}</p>

<h1>Hosts which require special configuration options can be listed in</h1>

<h1>host statements.   If no address is specified, the address will be</h1>

<h1>allocated dynamically (if possible), but the host-specific information</h1>

<h1>will still come from the host declaration.</h1>

<p>host passacaglia {
  hardware ethernet 0:0:c0:5d:bd:95;
  filename &ldquo;vmunix.passacaglia&rdquo;;
  server-name &ldquo;toccata.fugue.com&rdquo;;
}</p>

<h1>Fixed IP addresses can also be specified for hosts.   These addresses</h1>

<h1>should not also be listed as being available for dynamic assignment.</h1>

<h1>Hosts for which fixed IP addresses have been specified can boot using</h1>

<h1>BOOTP or DHCP.   Hosts for which no fixed address is specified can only</h1>

<h1>be booted with DHCP, unless there is an address range on the subnet</h1>

<h1>to which a BOOTP client is connected which has the dynamic-bootp flag</h1>

<h1>set.</h1>

<p>host fantasia {
  hardware ethernet 08:00:07:26:c0:a5;
  fixed-address fantasia.fugue.com;
}</p>

<h1>You can declare a class of clients and then do address allocation</h1>

<h1>based on that.   The example below shows a case where all clients</h1>

<h1>in a certain class get addresses on the 10.17.224/24 subnet, and all</h1>

<h1>other clients get addresses on the 10.0.29/24 subnet.</h1>

<p>class &ldquo;foo&rdquo; {
  match if substring (option vendor-class-identifier, 0, 4) = &ldquo;SUNW&rdquo;;
}</p>

<p>shared-network 224-29 {
  subnet 10.17.224.0 netmask 255.255.255.0 {</p>

<pre><code>option routers rtr-224.example.org;
</code></pre>

<p>  }
  subnet 10.0.29.0 netmask 255.255.255.0 {</p>

<pre><code>option routers rtr-29.example.org;
</code></pre>

<p>  }
  pool {</p>

<pre><code>allow members of "foo";
range 10.17.224.10 10.17.224.250;
</code></pre>

<p>  }
  pool {</p>

<pre><code>deny members of "foo";
range 10.0.29.10 10.0.29.230;
</code></pre>

<p>  }
}
```</p>

<p>This is how the config file looks like. We&rsquo;ll use this example as a basis for making our own. Copy the example file and name it <strong>dhcpd.conf</strong> file:</p>

<p><code>plain
cp /usr/share/doc/dhcp*/dhcpd.conf.example /etc/dhcp/dhcpd.conf
</code></p>

<p>Now edit it and make changes according to your network:</p>

<p>``` plain</p>

<h1>option definitions common to all supported networks&hellip;</h1>

<p>option domain-name &ldquo;localdomain.com&rdquo;;</p>

<h1>DNS server address &ndash; look in your /etc/resolv.conf</h1>

<p>option domain-name-servers 192.168.217.2;</p>

<p>default-lease-time 600;
max-lease-time 7200;</p>

<h1>declare your subnet config</h1>

<p>subnet 192.168.217.0 netmask 255.255.255.0 {
  # range of IPs to serve
  range 192.168.217.10 192.168.217.20;
  # the address of the routers &ndash; look for the gateway address in the route -n # command (entry containing UG)
  option routers 192.168.217.2;
}</p>

<p>host kaliclient {
hardware ethernet 00:0c:29:22:f9:ae;
fixed-address 192.168.217.12;
}
```</p>

<p>Here I declared the subnet for which the server would handle addresses, and I reserved an IP address for a client. For more options, you can look at the <code>dhcpd-options</code> man page.</p>

<p>Time to start the server. First, verify that the <code>/var/lib/dhcpd/dhcpd.leases</code> file exists, otherwise you will need to create an empty one before starting the server with the command <code>systemctl start dhcpd</code>. I changed my VMs connection settings to host-only, and then looked at the new IP configuration:</p>

<p>``` plain</p>

<h1>ifconfig on the host running the DHCP server</h1>

<p>inet 192.168.217.10  netmask 255.255.255.0  broadcast 192.168.217.255</p>

<h1>ifconfig on the kali client</h1>

<p>inet 192.168.217.12  netmask 255.255.255.0  broadcast 192.168.217.255
```</p>

<p>Success! Our DHCP server kicked in and gave addresses to 2 machines on the network!</p>

<p>``` plain
/ F.S. Fitzgerald to Hemingway:        \
|                                      |
| &ldquo;Ernest, the rich are different from |
| us.&rdquo; Hemingway:                      |
|                                      |
\ &ldquo;Yes. They have more money.&rdquo;         /</p>

<hr />

<pre><code>    \   ^__^
     \  (oo)\_______
        (__)\       )\/\
            ||----w |
            ||     ||
</code></pre>

<p>```</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Remote task automation with Fabric]]></title>
    <link href="http://chousensha.github.io/blog/2017/04/03/remote-task-automation-with-fabric/"/>
    <updated>2017-04-03T03:01:29-04:00</updated>
    <id>http://chousensha.github.io/blog/2017/04/03/remote-task-automation-with-fabric</id>
    <content type="html"><![CDATA[<p>Today I will go over the use of <a href="http://docs.fabfile.org/en/1.13/">Fabric</a>, a Python library and CLI tool for executing local / remote tasks via SSH.</p>

<p><strong>Requirements</strong>:</p>

<ul>
<li>Python 2.5 or 2.7</li>
<li>Paramiko</li>
<li>SSH</li>
</ul>


<p><strong>Features at a glance</strong>:</p>

<ul>
<li>run local or remote shell commands (also with the sudo option)</li>
<li>upload / download files</li>
<li>prompt for input</li>
<li>run Python functions</li>
<li>abort execution when encountering errors by default, but also allow for error handling</li>
</ul>


<p>Install Fabric with <code>pip install fabric</code></p>

<!-- more -->


<h2>Usage</h2>

<p>The way Fabric works is by creating a file named <code>fabfile.py</code>, containing some functions, and then using the <strong>fab</strong> CLI tool to run them.</p>

<p>Let&rsquo;s look at the options available with the <strong>fab</strong> tool:</p>

<p>``` plain
fab &mdash;help
Usage: fab [options] <command>[:arg1,arg2=val2,host=foo,hosts=&lsquo;h1;h2&rsquo;,&hellip;] &hellip;</p>

<p>Options:
  -h, &mdash;help            show this help message and exit
  -d NAME, &mdash;display=NAME</p>

<pre><code>                    print detailed info about command NAME
</code></pre>

<p>  -F FORMAT, &mdash;list-format=FORMAT</p>

<pre><code>                    formats --list, choices: short, normal, nested
</code></pre>

<p>  -I, &mdash;initial-password-prompt</p>

<pre><code>                    Force password prompt up-front
</code></pre>

<p>  &mdash;initial-sudo-password-prompt</p>

<pre><code>                    Force sudo password prompt up-front
</code></pre>

<p>  -l, &mdash;list            print list of possible commands and exit
  &mdash;set=KEY=VALUE,&hellip;   comma separated KEY=VALUE pairs to set Fab env vars
  &mdash;shortlist           alias for -F short &mdash;list
  -V, &mdash;version         show program&rsquo;s version number and exit
  -a, &mdash;no_agent        don&rsquo;t use the running SSH agent
  -A, &mdash;forward-agent   forward local agent to remote end
  &mdash;abort-on-prompts    abort instead of prompting (for password, host, etc)
  -c PATH, &mdash;config=PATH</p>

<pre><code>                    specify location of config file to use
</code></pre>

<p>  &mdash;colorize-errors     Color error output
  -D, &mdash;disable-known-hosts</p>

<pre><code>                    do not load user known_hosts file
</code></pre>

<p>  -e, &mdash;eagerly-disconnect</p>

<pre><code>                    disconnect from hosts as soon as possible
</code></pre>

<p>  -f PATH, &mdash;fabfile=PATH</p>

<pre><code>                    python module file to import, e.g. '../other.py'
</code></pre>

<p>  -g HOST, &mdash;gateway=HOST</p>

<pre><code>                    gateway host to connect through
</code></pre>

<p>  &mdash;gss-auth            Use GSS-API authentication
  &mdash;gss-deleg           Delegate GSS-API client credentials or not
  &mdash;gss-kex             Perform GSS-API Key Exchange and user authentication
  &mdash;hide=LEVELS         comma-separated list of output levels to hide
  -H HOSTS, &mdash;hosts=HOSTS</p>

<pre><code>                    comma-separated list of hosts to operate on
</code></pre>

<p>  -i PATH               path to SSH private key file. May be repeated.
  -k, &mdash;no-keys         don&rsquo;t load private key files from ~/.ssh/
  &mdash;keepalive=N         enables a keepalive every N seconds
  &mdash;linewise            print line-by-line instead of byte-by-byte
  -n M, &mdash;connection-attempts=M</p>

<pre><code>                    make M attempts to connect before giving up
</code></pre>

<p>  &mdash;no-pty              do not use pseudo-terminal in run/sudo
  -p PASSWORD, &mdash;password=PASSWORD</p>

<pre><code>                    password for use with authentication and/or sudo
</code></pre>

<p>  -P, &mdash;parallel        default to parallel execution method
  &mdash;port=PORT           SSH connection port
  -r, &mdash;reject-unknown-hosts</p>

<pre><code>                    reject unknown hosts
</code></pre>

<p>  &mdash;sudo-password=SUDO_PASSWORD</p>

<pre><code>                    password for use with sudo only
</code></pre>

<p>  &mdash;system-known-hosts=SYSTEM_KNOWN_HOSTS</p>

<pre><code>                    load system known_hosts file before reading user
                    known_hosts
</code></pre>

<p>  -R ROLES, &mdash;roles=ROLES</p>

<pre><code>                    comma-separated list of roles to operate on
</code></pre>

<p>  -s SHELL, &mdash;shell=SHELL</p>

<pre><code>                    specify a new shell, defaults to '/bin/bash -l -c'
</code></pre>

<p>  &mdash;show=LEVELS         comma-separated list of output levels to show
  &mdash;skip-bad-hosts      skip over hosts that can&rsquo;t be reached
  &mdash;skip-unknown-tasks  skip over unknown tasks
  &mdash;ssh-config-path=PATH</p>

<pre><code>                    Path to SSH config file
</code></pre>

<p>  -t N, &mdash;timeout=N     set connection timeout to N seconds
  -T N, &mdash;command-timeout=N</p>

<pre><code>                    set remote command timeout to N seconds
</code></pre>

<p>  -u USER, &mdash;user=USER  username to use when connecting to remote hosts
  -w, &mdash;warn-only       warn, instead of abort, when commands fail
  -x HOSTS, &mdash;exclude-hosts=HOSTS</p>

<pre><code>                    comma-separated list of hosts to exclude
</code></pre>

<p>  -z INT, &mdash;pool-size=INT</p>

<pre><code>                    number of concurrent processes to use in parallel mode
</code></pre>

<p>```</p>

<p>The <strong>fab</strong> tool can execute functions from a fabfile.py by passing the function name, like so: <code>fab func-name</code></p>

<h2>Examples</h2>

<p>Let&rsquo;s take a look at a couple of simple fabfiles, before making a more contrived one:</p>

<h3>Run commands on the local host</h3>

<p>``` python
from fabric.api import *</p>

<p>@task
def local_info():</p>

<pre><code>    local('whoami')
</code></pre>

<p>```</p>

<p>Run it:</p>

<p>``` plain
fab local_info          <br/>
[localhost] local: whoami
root</p>

<p>Done.
```</p>

<h3>Run commands on remote host &ndash; password authentication</h3>

<p>Next, let&rsquo;s use SSH with a password to log in to a remote host and do something on it:</p>

<p>``` python
from fabric.api import *</p>

<p>env.hosts = [&lsquo;192.168.216.128&rsquo;]
env.user = &lsquo;root&rsquo; # default is the local user
env.password = &lsquo;password&rsquo; # can be used both for SSH authentication and sudo</p>

<p>@task
def remote_info():</p>

<pre><code>    run('uname -a')
</code></pre>

<p>```</p>

<p>And the output:</p>

<p>``` plain
fab remote_info
[192.168.216.128] Executing task &lsquo;remote_info&rsquo;
[192.168.216.128] run: uname -a
[192.168.216.128] out: Linux localhost.localdomain 3.10.0-514.2.2.el7.x86_64 #1 SMP Tue Dec 6 23:06:41 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux
[192.168.216.128] out:</p>

<p>Done.
Disconnecting from 192.168.216.128&hellip; done.
```</p>

<h3>Run commands on remote host &ndash; key authentication</h3>

<p>SSH with a password might be ok for demonstration purposes, but we will most likely want to use public key authentication. First, generate the key that we&rsquo;ll use later:</p>

<p><code>plain
ssh-keygen -t rsa -b 2048 -v
Generating public/private rsa key pair.
Enter file in which to save the key (/root/.ssh/id_rsa): mykey.pem
Enter passphrase (empty for no passphrase):
Enter same passphrase again:
Your identification has been saved in mykey.pem.
Your public key has been saved in mykey.pem.pub.
</code></p>

<p>Next, copy the key to the remote host&rsquo;s <code>~/.ssh/authorized_keys</code> location:</p>

<p>``` plain
ssh-copy-id -i ~/mykey.pem.pub <a href="&#x6d;&#97;&#x69;&#x6c;&#116;&#111;&#x3a;&#114;&#111;&#111;&#116;&#x40;&#49;&#57;&#x32;&#x2e;&#x31;&#54;&#x38;&#x2e;&#x32;&#x31;&#x36;&#46;&#x31;&#x32;&#56;">&#114;&#111;&#x6f;&#116;&#x40;&#x31;&#x39;&#50;&#x2e;&#49;&#x36;&#x38;&#46;&#x32;&#x31;&#x36;&#46;&#x31;&#50;&#x38;</a>
/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: &ldquo;/root/mykey.pem.pub&rdquo;
/usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed
/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed &mdash; if you are prompted now it is to install the new keys
<a href="&#109;&#x61;&#105;&#x6c;&#116;&#x6f;&#58;&#x72;&#111;&#111;&#x74;&#64;&#49;&#57;&#x32;&#46;&#49;&#54;&#56;&#x2e;&#50;&#49;&#x36;&#46;&#x31;&#50;&#x38;">&#x72;&#111;&#111;&#116;&#64;&#x31;&#57;&#50;&#x2e;&#x31;&#54;&#56;&#46;&#50;&#49;&#54;&#x2e;&#49;&#x32;&#x38;</a>&rsquo;s password:</p>

<p>Number of key(s) added: 1</p>

<p>Now try logging into the machine, with:   &ldquo;ssh &lsquo;<a href="&#109;&#97;&#x69;&#108;&#116;&#x6f;&#x3a;&#x72;&#x6f;&#x6f;&#116;&#64;&#x31;&#57;&#x32;&#46;&#x31;&#x36;&#56;&#x2e;&#x32;&#49;&#x36;&#x2e;&#x31;&#x32;&#x38;">&#114;&#111;&#x6f;&#x74;&#64;&#x31;&#57;&#50;&#x2e;&#49;&#x36;&#56;&#x2e;&#x32;&#x31;&#x36;&#46;&#x31;&#50;&#56;</a>&rsquo;&rdquo;
and check to make sure that only the key(s) you wanted were added.
```</p>

<p>Make the .pem key read-only and then try logging in by passing it to the ssh -i option:</p>

<p><code>plain
chmod 400 mykey.pem
ssh -i mykey.pem root@192.168.216.128
Last failed login: Tue Mar 28 12:28:43 EEST 2017 from 192.168.216.1 on ssh:notty
There were 2 failed login attempts since the last successful login.
Last login: Tue Mar 28 11:30:19 2017 from 192.168.216.1
[root@localhost ~]#
</code></p>

<p>Now add the key file in Fabric:</p>

<p>``` python
from fabric.api import *</p>

<p>env.hosts = [&lsquo;192.168.217.131&rsquo;]
env.user = &lsquo;root&rsquo;
env.key_filename = &lsquo;~/.ssh/mykey.pem&rsquo;</p>

<p>@task
def remote_info():</p>

<pre><code>    run('uptime')
</code></pre>

<p>```</p>

<h3>Run commands on multiple hosts</h3>

<p>If you want to run a command on a host, and a different command on another host, you can do so by specifying which host you want to run a command on:</p>

<p>``` python
from fabric.api import *</p>

<p>env.user = &lsquo;root&rsquo;
env.key_filename = &lsquo;~/mykey.pem&rsquo;</p>

<p>@task
def local_info():</p>

<pre><code>print('This runs only on the localhost')
</code></pre>

<p>@hosts(&lsquo;192.168.216.128&rsquo;)
@task
def remote_info():</p>

<pre><code>    print('This runs only on the remote host')
</code></pre>

<p>```</p>

<p>Here is how it would look like:</p>

<p>``` plain
fab local_info remote_info
This runs only on the localhost
[192.168.216.128] Executing task &lsquo;remote_info&rsquo;
This runs only on the remote host</p>

<p>Done.
```</p>

<h3>Download / upload files</h3>

<p>Fabric also has built-in functionality for downloading and uploading files:</p>

<p>``` python
@task
def download():</p>

<pre><code>    get('~/Desktop/ssh.sh')
</code></pre>

<p>```</p>

<p>Result:</p>

<p>``` plain
fab download
[192.168.23.128] Executing task &lsquo;download&rsquo;
[192.168.23.128] download: path/192.168.23.128/ssh.sh &lt;&ndash; /root/Desktop/ssh.sh</p>

<p>Done.
Disconnecting from 192.168.23.128&hellip; done.
```</p>

<p>And the upload:</p>

<p>``` python
@task
def upload():</p>

<pre><code>    put('file.txt', '~/Desktop')
</code></pre>

<p>```</p>

<p>Output:</p>

<p>``` plain
fab upload
[192.168.23.128] Executing task &lsquo;upload&rsquo;
[192.168.23.128] put: file.txt &ndash;> /root/Desktop/file.txt</p>

<p>Done.
Disconnecting from 192.168.23.128&hellip; done.
```</p>

<h3>Run sudo commands</h3>

<p>We saw some examples of using the root user, but Fabric allows running sudo commands from users with lower privileges:</p>

<p>``` python
from fabric.api import *</p>

<p>env.hosts = [&lsquo;192.168.217.131&rsquo;]
env.user = &lsquo;nixhat&rsquo;</p>

<p>@task
def cfg_test():</p>

<pre><code>    sudo('apachectl configtest')
</code></pre>

<p>```</p>

<p>And here it is in action:</p>

<p>``` plain
fab cfg_test
[192.168.217.131] Executing task &lsquo;cfg_test&rsquo;
[192.168.217.131] sudo: apachectl configtest
[192.168.217.131] Login password for &lsquo;nixhat&rsquo;:
[192.168.217.131] out: sudo password:
[192.168.217.131] out: AH00558: httpd: Could not reliably determine the server&rsquo;s
 fully qualified domain name, using localhost.localdomain. Set the &lsquo;ServerName&rsquo;
directive globally to suppress this message
[192.168.217.131] out: Syntax OK
[192.168.217.131] out:</p>

<p>Done.
Disconnecting from 192.168.217.131&hellip; done.
```</p>

<h3>Specifying multiple hosts with different users and passwords</h3>

<p>In case you have many hosts that you would like to run commands on as different users, you can do so:</p>

<p><code>python
env.hosts = ['root@192.168.217.130', 'nixhat@192.168.216.128'] # hosts to run cmds on
env.passwords = {'root@192.168.217.130':'password1', 'nixhat@192.168.216.128':'password2'}
</code></p>

<h3>Running tasks on predefined hosts</h3>

<p>If you have tasks that you want to run on certain hosts only, you can specify that:</p>

<p>``` python
@hosts(&lsquo;host1&rsquo;, &lsquo;host2&rsquo;)
def mytask():</p>

<pre><code>run('cmd')
</code></pre>

<p>```</p>

<h3>Classifying hosts into roles</h3>

<p>In a large environment, you are most likely to have many hosts that fulfill some roles, such as development machines and production servers. You can organize them in the Fabric code:</p>

<p>``` python
env.roledefs = {</p>

<pre><code>'production': ['prod1', 'prod2'],
'development': ['dev1', 'dev2']
</code></pre>

<p>}
```</p>

<h3>Automating code deployment</h3>

<p>In a <a href="https://chousensha.github.io/blog/2017/03/30/using-git-for-code-deployment/">previous post</a>, we used Git for updating the code on a live server from a development machine. This time, we&rsquo;ll use Fabric to automate the process!</p>

<p>Besides the development and production servers we had before, we&rsquo;ll use a third computer to run the Fabric commands from. Let&rsquo;s assume this is your sysadmin machine, from which magic happens on the network. The developers made some changes to the code on the dev server, and you want to push them to production:</p>

<p>``` python
from fabric.api import *</p>

<h1>script must be called fabfile.py</h1>

<h1>fab -l &ndash; list available cmds</h1>

<h1>fab CMDNAME &ndash; run cmd</h1>

<h1>the env dictionary allows for setting different variables for customizing the configuration</h1>

<p>env.colorize_errors = &lsquo;true&rsquo; # color errors in red and warnings in magenta</p>

<p>env.roledefs = {</p>

<pre><code>'dev': ['root@192.168.217.130:22 '],
'prod': ['root@192.168.217.131:22'],
}
</code></pre>

<p>env.passwords = {&lsquo;root@192.168.217.130:22&rsquo;:&lsquo;5t0rm80rn&rsquo;, &lsquo;root@192.168.217.131:22&rsquo;:&lsquo;hakubo10&rsquo;}</p>

<p>@roles(&lsquo;dev&rsquo;)
@task
def prep():</p>

<pre><code>'''
Stage and commit new and modified files
:return:
'''
with settings(warn_only=True): # continue executing even if errors were encountered
    with cd('/root/Testing/Dev'):
        run('git add . &amp;&amp; git commit -m "Add changes"')
</code></pre>

<p>@roles(&lsquo;dev&rsquo;)
@task
def push():</p>

<pre><code>with cd('/root/Testing/Dev'):
    run('git push production')
</code></pre>

<p>@roles(&lsquo;prod&rsquo;)
@task
def chk():</p>

<pre><code>'''
Confirm that files have been updated on the web server
:return:
'''
run('ls /var/www/html/myweb/site')
</code></pre>

<p>```</p>

<p>Now list the available commands:</p>

<p>``` plain
fab -l
Available commands:</p>

<pre><code>chk   Confirm that files have been updated on the web server
prep  Stage and commit new and modified files
push
</code></pre>

<p>```</p>

<p>And run them:</p>

<p>``` plain
fab prep push chk
[root@192.168.217.130:22] Executing task &lsquo;prep&rsquo;
[root@192.168.217.130:22] run: git add . &amp;&amp; git commit -m &ldquo;Add changes&rdquo;
[root@192.168.217.130:22] out: [master 5719a02] Add changes
[root@192.168.217.130:22] out:  1 file changed, 1 insertion(+), 1 deletion(&ndash;)
[root@192.168.217.130:22] out:</p>

<p>[root@192.168.217.130:22] Executing task &lsquo;push&rsquo;
[root@192.168.217.130:22] run: git push production
[root@192.168.217.130:22] out: <a href="&#x6d;&#97;&#105;&#108;&#x74;&#x6f;&#x3a;&#114;&#111;&#x6f;&#x74;&#64;&#x31;&#57;&#x32;&#x2e;&#x31;&#x36;&#56;&#x2e;&#x32;&#x31;&#x37;&#46;&#49;&#51;&#49;">&#x72;&#111;&#111;&#x74;&#x40;&#49;&#57;&#x32;&#x2e;&#x31;&#54;&#x38;&#x2e;&#x32;&#x31;&#x37;&#46;&#x31;&#51;&#49;</a>&rsquo;s password:
[root@192.168.217.130:22] out: Counting objects: 3, done.
[root@192.168.217.130:22] out: Compressing objects:  33% (1/3)
[root@192.168.217.130:22] out: Compressing objects:  66% (2/3)
[root@192.168.217.130:22] out: Compressing objects: 100% (3/3)
[root@192.168.217.130:22] out: Compressing objects: 100% (3/3), done.
[root@192.168.217.130:22] out: Writing objects:  33% (1/3)
[root@192.168.217.130:22] out: Writing objects:  66% (2/3)
[root@192.168.217.130:22] out: Writing objects: 100% (3/3)
[root@192.168.217.130:22] out: Writing objects: 100% (3/3), 294 bytes | 0 bytes/
s, done.
[root@192.168.217.130:22] out: Total 3 (delta 2), reused 0 (delta 0)
[root@192.168.217.130:22] out: To 192.168.217.131:Prod
[root@192.168.217.130:22] out:    39e598d..5719a02  master &ndash;> master
[root@192.168.217.130:22] out:</p>

<p>[root@192.168.217.131:22] Executing task &lsquo;chk&rsquo;
[root@192.168.217.131:22] run: ls /var/www/html/myweb/site
[root@192.168.217.131:22] out: index.html  new.html  updates.html
[root@192.168.217.131:22] out:</p>

<p>Done.
Disconnecting from <a href="&#x6d;&#x61;&#105;&#108;&#x74;&#x6f;&#x3a;&#x72;&#111;&#111;&#x74;&#x40;&#49;&#57;&#50;&#x2e;&#49;&#54;&#56;&#46;&#x32;&#49;&#x37;&#46;&#49;&#51;&#x30;&#46;&#46;&#x2e;">&#114;&#x6f;&#x6f;&#116;&#x40;&#49;&#57;&#50;&#x2e;&#49;&#54;&#x38;&#x2e;&#50;&#x31;&#x37;&#x2e;&#x31;&#51;&#x30;&#x2e;&#x2e;&#46;</a> done.
Disconnecting from <a href="&#x6d;&#97;&#105;&#x6c;&#x74;&#111;&#x3a;&#x72;&#x6f;&#111;&#116;&#x40;&#x31;&#57;&#x32;&#46;&#x31;&#x36;&#56;&#46;&#50;&#x31;&#x37;&#46;&#49;&#x33;&#49;&#46;&#46;&#x2e;">&#114;&#x6f;&#x6f;&#116;&#x40;&#x31;&#57;&#50;&#46;&#x31;&#x36;&#56;&#x2e;&#50;&#49;&#55;&#46;&#x31;&#51;&#x31;&#46;&#46;&#46;</a> done.
```</p>

<p>In a file with many tasks, it will get tiresome to always specify them on the command line. You can organize your code to have a function that calls other tasks, respecting the roles and settings for each. Add this to the previous code:</p>

<p>``` python
@task
def deploy():</p>

<pre><code>'''
Execute previous tasks by taking into account the defined roles 
:return:
'''
execute(prep) # on dev
execute (push) # on dev
execute(chk) # on prod
</code></pre>

<p>```</p>

<p>Now you can run only <code>fab deploy</code> to get the same results!</p>

<p>``` plain
/ In the stairway of life, you&rsquo;d best \
\ take the elevator.                  /</p>

<hr />

<pre><code>    \   ^__^
     \  (oo)\_______
        (__)\       )\/\
            ||----w |
            ||     ||
</code></pre>

<p>```</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Using Git for code deployment]]></title>
    <link href="http://chousensha.github.io/blog/2017/03/30/using-git-for-code-deployment/"/>
    <updated>2017-03-30T07:09:46-04:00</updated>
    <id>http://chousensha.github.io/blog/2017/03/30/using-git-for-code-deployment</id>
    <content type="html"><![CDATA[<p>Imagine you have a local server where you work on developing the code for a web application. After doing your magic, you want to upload it to the web server so the rest of the world can access your shiny new web app. To do that, you have to place your code on another server, which serves as the production environment. Moreover, when making changes to your code, you only want to update the modified files, not everything.</p>

<!-- more -->


<p>You could keep track of what files have been changed on your dev server, and then manually transfer them to the web server in production. Now that we have established how much time and sanity you would lose, especially with a big app, let&rsquo;s see how Git can make this kind of code deployment not only possible, but also smooth and efficient.</p>

<p>I will be using the root account for this demo, which is of course a bad idea in a live environment, so keep that in mind =D</p>

<p>On the server side, say we have a folder named Prod. Here we will push the code for a website, and then we&rsquo;ll transfer it to the web directory.</p>

<p>First, initialize a bare repository inside the Prod folder:</p>

<p><code>plain
git init --bare
Initialized empty Git repository in /root/Prod/
</code></p>

<p>For better security, we&rsquo;ll keep the git repository outside the web root directory. To automatically update the code, we&rsquo;ll use a git hook, which is a script that runs when a certain event occurs. In this case, we&rsquo;ll create a <code>post-receive</code> hook, which runs on a remote repository after a git push</p>

<p>In the hooks directory, I created a hook called post-receive, with the following code in it:</p>

<p>``` plain</p>

<h1>!/bin/sh</h1>

<p>GIT_WORK_TREE=/var/www/html/myweb/site git checkout -f # path to the web root, it has to be created beforehand
```</p>

<p>Looking inside the hooks directory, you will see the samples are executable. We also have to make ours executable, so use <code>chmod +x</code></p>

<p>With that, the production server setup is complete. On the local development server, make a repository and add some files that you want to end up in production:</p>

<p>``` plain
root@pwnbox:~/Testing/Dev#git add .
root@pwnbox:~/Testing/Dev#git status
On branch master</p>

<p>Initial commit</p>

<p>Changes to be committed:
  (use &ldquo;git rm &mdash;cached <file>&hellip;&rdquo; to unstage)</p>

<pre><code>new file:   index.html
new file:   updates.html
</code></pre>

<p>```</p>

<p>Now add a remote, which will point to the production repository:</p>

<p><code>plain
git remote add production root@192.168.217.131:Prod
</code></p>

<p>Make a commit:</p>

<p><code>plain
git commit -m '1st commit'
[master (root-commit) bac80ea] 1st commit
 2 files changed, 2 insertions(+)
 create mode 100644 index.html
 create mode 100644 updates.html
</code></p>

<p>And now push the changes to production &mdash; note the use of the <a href="https://www.git-scm.com/book/tr/v2/Git-Internals-The-Refspec">refspec</a>:</p>

<p><code>plain
git push production +master:refs/heads/master
root@192.168.217.131's password:
Counting objects: 4, done.
Compressing objects: 100% (2/2), done.
Writing objects: 100% (4/4), 331 bytes | 0 bytes/s, done.
Total 4 (delta 0), reused 0 (delta 0)
To 192.168.217.131:Prod
 * [new branch]      master -&gt; master
</code></p>

<p>Let&rsquo;s see if it worked! On my production server:</p>

<p><img class="center" src="/images/sysadmin/git1.png" title="&lsquo;Code updated&rsquo; &lsquo;Code was pushed to web server&rsquo;" ></p>

<p><img class="center" src="/images/sysadmin/git2.png" title="&lsquo;Code updated&rsquo; &lsquo;Code was pushed to web server&rsquo;" ></p>

<p>It did work! Now let&rsquo;s update a file, and only push this file which has been modified. After making the modifications, look at the current status:</p>

<p>``` plain
git status
On branch master
Changes not staged for commit:
  (use &ldquo;git add <file>&hellip;&rdquo; to update what will be committed)
  (use &ldquo;git checkout &mdash; <file>&hellip;&rdquo; to discard changes in working directory)</p>

<pre><code>modified:   updates.html
</code></pre>

<p>no changes added to commit (use &ldquo;git add&rdquo; and/or &ldquo;git commit -a&rdquo;)
```</p>

<p>Commit the modified file:</p>

<p><code>plain
git commit -a -m 'Update to 1 file'
</code></p>

<p>And now push to production and also set the remote branch so next time you can do it with a simple <code>git push production</code>:</p>

<p><code>plain
git push --set-upstream production master
root@192.168.217.131's password:
Counting objects: 3, done.
Compressing objects: 100% (3/3), done.
Writing objects: 100% (3/3), 345 bytes | 0 bytes/s, done.
Total 3 (delta 0), reused 0 (delta 0)
To 192.168.217.131:Prod
   bac80ea..6fcdb86  master -&gt; master
Branch master set up to track remote branch master from production.
</code></p>

<p><img class="center" src="/images/sysadmin/git3.png" title="&lsquo;Changed file uploaded&rsquo; &lsquo;The modified file was successfully updated&rsquo;" ></p>

<p>And to confirm that on the production environment, only the modified file was updated, but the unchanged one remained the same:</p>

<p><code>plain
[root@localhost site]# ls -la
total 8
drwxr-xr-x. 2 root root 42 Mar 30 14:03 .
drwxr-xr-x. 3 root root 76 Mar 30 13:30 ..
-rw-r--r--. 1 root root 26 Mar 30 13:21 index.html
-rw-r--r--. 1 root root 71 Mar 30 14:03 updates.html
</code></p>

<p>It might not look like much for the 2 small files I have here, but in a huge code environment, you will feel the difference!</p>

<p>``` plain</p>

<hr />

<p>/ Your boss climbed the corporate ladder, \
\ wrong by wrong.                         /</p>

<hr />

<pre><code>    \   ^__^
     \  (oo)\_______
        (__)\       )\/\
            ||----w |
            ||     ||
</code></pre>

<p>```</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Setting up MySQL and PHP on Apache]]></title>
    <link href="http://chousensha.github.io/blog/2017/02/25/setting-up-mysql-and-php-on-apache/"/>
    <updated>2017-02-25T03:58:37-05:00</updated>
    <id>http://chousensha.github.io/blog/2017/02/25/setting-up-mysql-and-php-on-apache</id>
    <content type="html"><![CDATA[<p>It&rsquo;s been a while since my last post, but a full time job + the Cisco Cybersecurity scholarship are really eating into my time. But I will try to sneak a post here and there, whenever I can!</p>

<p>In a <a href="http://chousensha.github.io/blog/2016/08/05/getting-started-with-apache/">previous post</a>, I made a tutorial about setting up Apache on CentOS. The next step is to fire a MySQL server and put some databases on that web server!</p>

<!-- more -->


<h2>Installing MySQL server</h2>

<p>First, we need to visit the <a href="https://dev.mysql.com/downloads/repo/yum/">MySQL community repository</a> to download the server package:</p>

<p>``` plain
wget <a href="https://repo.mysql.com/mysql57-community-release-el7-9.noarch.rpm">https://repo.mysql.com/mysql57-community-release-el7-9.noarch.rpm</a>
&mdash;2017-01-19 10:06:02&mdash;  <a href="https://repo.mysql.com/mysql57-community-release-el7-9.noarch.rpm">https://repo.mysql.com/mysql57-community-release-el7-9.noarch.rpm</a>
Resolving repo.mysql.com (repo.mysql.com)&hellip; 104.87.9.47
Connecting to repo.mysql.com (repo.mysql.com)|104.87.9.47|:443&hellip; connected.
HTTP request sent, awaiting response&hellip; 200 OK
Length: 9224 (9.0K) [application/x-redhat-package-manager]
Saving to: ‘mysql57-community-release-el7-9.noarch.rpm’</p>

<p>100%[===========================================================================================================>] 9,224       &mdash;.-K/s   in 0s</p>

<p>2017-01-19 10:06:02 (137 MB/s) &ndash; ‘mysql57-community-release-el7-9.noarch.rpm’ saved [9224/9224]
```</p>

<p>Next we install the package:</p>

<p><code>plain
rpm -ivh mysql57-community-release-el7-9.noarch.rpm
warning: mysql57-community-release-el7-9.noarch.rpm: Header V3 DSA/SHA1 Signature, key ID 5072e1f5: NOKEY
Preparing...                          ################################# [100%]
Updating / installing...
   1:mysql57-community-release-el7-9  ################################# [100%]
</code></p>

<p>After running <code>yum update</code> and waiting for a while, you can install MySQL server from the newly added repository with <code>yum install mysql-server</code>.</p>

<p>After the installation, a new user has been created in <code>/etc/passwd</code>, and a group in <code>/etc/group</code>:</p>

<p>``` plain
cat /etc/passwd | grep mysql
mysql:x:27:27:MySQL Server:/var/lib/mysql:/bin/false</p>

<p>cat /etc/group | grep mysql
mysql:x:27:
```</p>

<h2>Configuration</h2>

<p>Next, start the service with <code>systemctl start mysqld</code>. The next step is to run the <code>mysql_secure_installation</code> binary to make some security configurations to your server, but for that you need the temporary root password that was generated during installation:</p>

<p><code>plain
grep 'password' /var/log/mysqld.log
2017-01-19T08:53:45.638708Z 1 [Note] A temporary password is generated for root@localhost: hoPAejdrk6_a
</code></p>

<p>After running <code>mysql_secure_installation</code>, you will be asked to change the root password in accordance with a policy that requires 12 characters, with a mix of uppercase, lowercase, numbers and special characters. Then you will be prompted to answer some questions regarding the removal of anonymous users, test databases, and disallowing remote root login.</p>

<p>To access your MySQL instance via the command line, log in as root and give your password:</p>

<p>``` plain
mysql -u root -p
Enter password:
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 16
Server version: 5.7.17 MySQL Community Server (GPL)</p>

<p>Copyright &copy; 2000, 2016, Oracle and/or its affiliates. All rights reserved.</p>

<p>Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.</p>

<p>Type &lsquo;help;&rsquo; or &lsquo;\h&rsquo; for help. Type &lsquo;\c&rsquo; to clear the current input statement.</p>

<p>mysql>
```</p>

<p>Let&rsquo;s look at what databases are available:</p>

<p><code>plain
show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
| sys                |
+--------------------+
4 rows in set (0.00 sec)
</code></p>

<p>I created a new database to play with:</p>

<p><code>plain
mysql&gt; create database vip;
Query OK, 1 row affected (0.00 sec)
</code></p>

<p>Now change the current DB to point the one you created:</p>

<p><code>plain
mysql&gt; use vip;
Database changed
</code></p>

<h3>Backup and restoration</h3>

<p>Before throwing some data into it, let&rsquo;s first see how to back up data and restore it. For this, we have the <strong>mysqldump</strong> utility. To make a backup of my newly created DB, I typed: <code>mysqldump -u root -p vip > backup.sql</code>.</p>

<p>Then I deleted the DB with the <code>drop database vip;</code> command. For some reason though, I could not restore the DB without first creating a DB with the same name. The restore command is <code>mysql -u root -p vip &lt; backup.sql</code>.</p>

<h3>Adding data to DB</h3>

<p>The database is all well and good, but we need to put a table in there!</p>

<p><code>sql
create table users (
name VARCHAR(10)
);
</code></p>

<p>I made a <em>users</em> table with one column for the <em>name</em>. Let&rsquo;s confirm this:</p>

<p><code>plain
mysql&gt; show tables;
+---------------+
| Tables_in_vip |
+---------------+
| users         |
+---------------+
1 row in set (0.00 sec)
</code></p>

<p>Next, I made some users:</p>

<p>``` plain
mysql> insert into users values (&lsquo;root&rsquo;);
Query OK, 1 row affected (0.04 sec)</p>

<p>mysql> insert into users values (&lsquo;guest&rsquo;);
Query OK, 1 row affected (0.00 sec)</p>

<p>mysql> select * from users;
+&mdash;&mdash;&mdash;&ndash;+
| name  |
+&mdash;&mdash;&mdash;&ndash;+
| root  |
| guest |
+&mdash;&mdash;&mdash;&ndash;+
2 rows in set (0.00 sec)
```</p>

<p>Let&rsquo;s see the DB in action by integrating it with some PHP!</p>

<h2>Installing PHP</h2>

<p>Installing PHP on CentOS can be done with the following command: <code>yum install php php-mysql</code></p>

<p>The next step is to write some PHP code to connect to the DB. But this is not Debian, so nothing just works! There is the pesky SELinux to take into account, and it&rsquo;s not letting Apache to reach the MySQL DB. Use <strong>getsebool</strong> to see the boolean values for the web server:</p>

<p><code>plain
getsebool -a | grep httpd
httpd_anon_write --&gt; off
httpd_builtin_scripting --&gt; on
httpd_can_check_spam --&gt; off
httpd_can_connect_ftp --&gt; off
httpd_can_connect_ldap --&gt; off
httpd_can_connect_mythtv --&gt; off
httpd_can_connect_zabbix --&gt; off
httpd_can_network_connect --&gt; off
httpd_can_network_connect_cobbler --&gt; off
httpd_can_network_connect_db --&gt; off
httpd_can_network_memcache --&gt; off
httpd_can_network_relay --&gt; off
httpd_can_sendmail --&gt; off
httpd_dbus_avahi --&gt; off
httpd_dbus_sssd --&gt; off
httpd_dontaudit_search_dirs --&gt; off
httpd_enable_cgi --&gt; on
httpd_enable_ftp_server --&gt; off
httpd_enable_homedirs --&gt; off
httpd_execmem --&gt; off
httpd_graceful_shutdown --&gt; on
httpd_manage_ipa --&gt; off
httpd_mod_auth_ntlm_winbind --&gt; off
httpd_mod_auth_pam --&gt; off
httpd_read_user_content --&gt; off
httpd_run_ipa --&gt; off
httpd_run_preupgrade --&gt; off
httpd_run_stickshift --&gt; off
httpd_serve_cobbler_files --&gt; off
httpd_setrlimit --&gt; off
httpd_ssi_exec --&gt; off
httpd_sys_script_anon_write --&gt; off
httpd_tmp_exec --&gt; off
httpd_tty_comm --&gt; off
httpd_unified --&gt; off
httpd_use_cifs --&gt; off
httpd_use_fusefs --&gt; off
httpd_use_gpg --&gt; off
httpd_use_nfs --&gt; off
httpd_use_openstack --&gt; off
httpd_use_sasl --&gt; off
httpd_verify_dns --&gt; off
</code></p>

<p>As you can see, by default Apache is very limited in what it can do. Let&rsquo;s change that and allow it to connect to the DB server, and make the change persist across reboots:</p>

<p><code>plain
setsebool -P httpd_can_network_connect_db 1
</code></p>

<p>If you check again, you will see that the <code>httpd_can_network_connect_db</code> boolean is now set to on. I&rsquo;ve used the code from the <a href="http://php.net/manual/en/function.mysqli-connect.php">PHP mysqli_connect() documentation</a> to check the connection status, and finally, it went from failure to success.</p>

<p>``` php</p>

<p>&lt;?php
$link = mysqli_connect(&ldquo;127.0.0.1&rdquo;, &ldquo;my_user&rdquo;, &ldquo;my_password&rdquo;, &ldquo;my_db&rdquo;);</p>

<p>if (!$link) {</p>

<pre><code>echo "Error: Unable to connect to MySQL." . PHP_EOL;
echo "Debugging errno: " . mysqli_connect_errno() . PHP_EOL;
echo "Debugging error: " . mysqli_connect_error() . PHP_EOL;
exit;
</code></pre>

<p>}</p>

<p>echo &ldquo;Success: A proper connection to MySQL was made! The my_db database is great.&rdquo; . PHP_EOL;
echo &ldquo;Host information: &rdquo; . mysqli_get_host_info($link) . PHP_EOL;</p>

<p>mysqli_close($link);
?>
```</p>

<p>Next, I made a really basic, vulnerable page just to see if things are working. I placed the following PHP file in my web server directory:</p>

<p>``` php</p>

<p><html></p>

<p><form action="reallyproform.php" method="post">
   <p>Enter a name in this box to see if you know anyone in the VIP area: <input type="text" name="username" /></p>
   <input type="submit" name="submit" value="Submit" />
</form></p>

<p></body></p>

<p></html></p>

<p>&lt;?php
$link = mysqli_connect(&ldquo;127.0.0.1&rdquo;, &ldquo;username&rdquo;, &ldquo;password&rdquo;, &ldquo;database name&rdquo;);</p>

<p>$username = $_POST[&lsquo;username&rsquo;];</p>

<p>$query = &ldquo;SELECT * FROM users WHERE name = &lsquo;&rdquo;.$username.&ldquo;&rsquo;&rdquo;;
$result = mysqli_query($link,$query);</p>

<p>if(mysqli_num_rows($result)>=1)</p>

<pre><code>       {
        echo"Yes you are. Proceed";
       }
</code></pre>

<p>else
{
echo &ldquo;Are you sure you&rsquo;re supposed to be here?&rdquo;;
}</p>

<p>mysqli_close($link);
?></p>

<p>```</p>

<p><img class="center" src="/images/sysadmin/page.png" title="&lsquo;Sample PHP page&rsquo; &lsquo;PHP form&rsquo;" ></p>

<p>If you enter a valid username, you will just get a message, but this was just an example to show a working connection between the PHP code hosted on the server and the MySQL database.</p>

<h3>phpMyAdmin setup</h3>

<p>Chances are, you won&rsquo;t feel an urge to always interact with your DB via the command line. The last step in this post is to install and configure phpMyAdmin in order to do all the SQL operations from a web interface.</p>

<p>First, install it with the following command:</p>

<p><code>plain
yum install phpmyadmin
</code></p>

<p>Restart Apache and go to <a href="http://127.0.0.1/phpmyadmin">http://127.0.0.1/phpmyadmin</a> to see your new phpMyAdmin interface.</p>

<p>``` plain
/ You plan things that you do not even \
| attempt because of your extreme      |
\ caution.                             /</p>

<hr />

<pre><code>    \   ^__^
     \  (oo)\_______
        (__)\       )\/\
            ||----w |
            ||     ||
</code></pre>

<p>```</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Getting started with Apache]]></title>
    <link href="http://chousensha.github.io/blog/2016/08/05/getting-started-with-apache/"/>
    <updated>2016-08-05T07:26:16-04:00</updated>
    <id>http://chousensha.github.io/blog/2016/08/05/getting-started-with-apache</id>
    <content type="html"><![CDATA[<p>In this post I will go over the installation and configuration of an Apache web server on CentOS.</p>

<!-- more -->


<h1>Installation</h1>

<p>First, let&rsquo;s verify whether Apache is already installed. Note that on CentOS, the package (and process name) for Apache is called <strong>httpd</strong>.</p>

<p><code>plain
rpm -q httpd
package httpd is not installed
ls -l /var/www
ls: cannot access /var/www: No such file or directory
</code></p>

<p>Apache is not installed, so let&rsquo;s install it with <code>yum install httpd</code>. Now verify that it has been installed:</p>

<p><code>plain
rpm -q httpd
httpd-2.4.6-40.el7.centos.4.x86_64
ls -l /var/www
total 0
drwxr-xr-x. 2 root root 6 Jul 18 18:30 cgi-bin
drwxr-xr-x. 2 root root 6 Jul 18 18:30 html
</code></p>

<p>Remember that the directory for Apache configuration is <code>/etc/httpd</code>:</p>

<p><code>plain
[root@localhost ~]# ls /etc/httpd
conf  conf.d  conf.modules.d  logs  modules  run
</code></p>

<p>And the Apache configuration file is <code>/etc/httpd/conf/httpd.conf</code>. I included a snapshot of a fresh config file at the end of this post.</p>

<h1>Configuration</h1>

<p>Now we can start Apache and check that it is running with the <strong>apachectl</strong> command, that provides a front-end control interface for the httpd daemon. For reference, the man page for this utility is at the end of the post.</p>

<p>To start the web server, type <code>apachectl start</code> (alternatively, you can do it with <code>service httpd start</code>, and can use the httpd daemon directly to pass arguments, etc. At the end I&rsquo;ve also included the httpd man page.</p>

<p>If you&rsquo;re getting a message like &ldquo;Could not reliably determine the server&rsquo;s fully qualified domain name&rdquo;, you can modify the ServerName in the configuration file and then restart the server. After making changes to the config file, it&rsquo;s also a good idea to check if there are any errors in it:</p>

<p><code>plain
[root@freehat ~]# apachectl configtest
Syntax OK
</code></p>

<p>Now, let&rsquo;s check the status of the server:</p>

<p>``` plain
[root@localhost ~]# apachectl status
* httpd.service &ndash; The Apache HTTP Server
   Loaded: loaded (/usr/lib/systemd/system/httpd.service; disabled; vendor preset: disabled)
   Active: active (running) since Tue 2016-08-02 15:53:53 EEST; 1min 42s ago</p>

<pre><code> Docs: man:httpd(8)
       man:apachectl(8)
</code></pre>

<p> Main PID: 5941 (httpd)
   Status: &ldquo;Total requests: 0; Current requests/sec: 0; Current traffic:   0 B/sec&rdquo;
[snip]
```</p>

<p>Also, if you want Apache to start on boot, you need to specify it:</p>

<p><code>plain
chkconfig httpd on
Note: Forwarding request to 'systemctl enable httpd.service'.
Created symlink from /etc/systemd/system/multi-user.target.wants/httpd.service to /usr/lib/systemd/system/httpd.service.
</code></p>

<p>If you need to troubleshoot your Apache, you can consult the error log at <code>/var/log/httpd/error_log</code>.</p>

<h2>Site setup</h2>

<p>To add an index for your site, create an <em>index.html</em> file inside <code>/var/www/html/</code>. This is what you&rsquo;ll see when visiting your site.</p>

<p><code>plain
[root@localhost ~]# echo 'Hello interwebz!' &gt; /var/www/html/index.html
</code></p>

<p>When you navigate to your website, this page will be what you&rsquo;ll see. On other distributions, a default index.html may be present in the website root (identified by the DocumentRoot directive).</p>

<h3>Virtual hosts</h3>

<p>Virtual hosts allow you to run multiple websites on a single server. Let&rsquo;s see some examples of how we can do that.</p>

<h4>Port-based vhosts</h4>

<p>One option is to <strong>put each website on a different port</strong>. In addition to our main website on port 80, let&rsquo;s serve a different one on port 8080.</p>

<p>First, add a new Listen directive in <code>/etc/httpd/conf/httpd.conf</code>, to tell Apache to also listen on port 8080:</p>

<p><code>plain
Listen 80
Listen 8080
</code></p>

<p>We could add virtual hosts in the main configuration file, but if you plan to serve many websites, better to create separate configuration files for each virtual host. Check that the line telling Apache to load other config files is uncommented:</p>

<p>``` plain</p>

<h1>Load config files in the &ldquo;/etc/httpd/conf.d&rdquo; directory, if any.</h1>

<p>IncludeOptional conf.d/*.conf
```</p>

<p>Now, create a config file for a specific virtual host (it must end in .conf):</p>

<p>``` plain
[root@freehat ~]# nano /etc/httpd/conf.d/skynet.conf
[root@freehat ~]# cat /etc/httpd/conf.d/skynet.conf
<VirtualHost *:8080></p>

<pre><code>DocumentRoot "/var/www/html/skynet"
ServerName skynet.local
</code></pre>

<p></VirtualHost>
```</p>

<p>Next, create the necessary document root directory:</p>

<p><code>plain
[root@freehat ~]# mkdir /var/www/html/skynet
</code></p>

<p>Put some resource that you want to be server in the folder:</p>

<p><code>plain
[root@freehat ~]# echo 'You are marked for extermination' &gt;  /var/www/html/skynet/index.html
</code></p>

<p>The last step is to tell Apache to reload its configuration files with <code>service httpd reload</code>. However, now I ran into some SELinux alert. I looked in <code>/var/log/messages</code>:</p>

<p><code>plain
Aug  3 16:16:16 localhost setroubleshoot: SELinux is preventing /usr/sbin/httpd from name_connect access on the tcp_socket port 8080. For complete SELinux messages. run sealert -l bc571bd3-344f-4a4e-830a-ce744154d527
</code></p>

<p>I ran the mentioned command but was confused by my first brush with SELinux, so I did some google-fu which led me to <a href="https://www.certdepot.net/rhel7-use-selinux-port-labelling/">this post</a>. You can verify what ports are allowed by SELinux for HTTP traffic with the below command:</p>

<p><code>plain
[root@freehat ~]# semanage port -l | grep http
http_cache_port_t              tcp      8080, 8118, 8123, 10001-10010
http_cache_port_t              udp      3130
http_port_t                    tcp      80, 81, 443, 488, 8008, 8009, 8443, 9000
pegasus_http_port_t            tcp      5988
pegasus_https_port_t           tcp      5989
</code></p>

<p>To add port 8080 to http_port_t, I ran <code>semanage port -m -t http_port_t -p tcp 8080</code>, and then I checked it was added. Should be all good now. If you go visit your server on port 8080, you should get a friendly message. To differentiate it from the website on port 80, create another virtual host configuration for that respective server.</p>

<p>You can now access your sites from your own machine, but if you try navigating to them from another computer, it will be just like the websites don&rsquo;t exist! It turns out, iptables is blocking access, and you have to tell it to open the ports:</p>

<p><code>plain
[root@freehat sysconfig]# iptables -I INPUT -p tcp --dport 80 -j ACCEPT
[root@freehat sysconfig]# iptables -I INPUT -p tcp --dport 8080 -j ACCEPT
</code></p>

<p>And if you want these changes to survive a reboot, you should save them. I had to do some additional work for that. It turns out, <a href="https://stackoverflow.com/questions/24756240/how-can-i-use-iptables-on-centos-7">RHEL 7 and CentOS 7 use <em>firewalld</em></a> to manage iptables. So first I followed the instructions on StackOverflow to stop and mask the firewalld service:</p>

<p><code>plain
systemctl stop firewalld
[root@freehat ~]# systemctl mask firewalld
Created symlink from /etc/systemd/system/firewalld.service to /dev/null.
</code></p>

<p>Then I had to install <em>iptables-services</em>: <code>yum install iptables-services</code>. Next I enabled it at boot:</p>

<p><code>plain
systemctl enable iptables
Created symlink from /etc/systemd/system/basic.target.wants/iptables.service to /usr/lib/systemd/system/iptables.service.
</code></p>

<p>I also modified the &ldquo;no&rdquo; defaults in <code>/etc/sysconfig/iptables-config</code> to &ldquo;yes&rdquo;:</p>

<p>``` plain</p>

<h1>Save current firewall rules on stop.</h1>

<h1>Value: yes|no,  default: no</h1>

<h1>Saves all firewall rules to /etc/sysconfig/iptables if firewall gets stopped</h1>

<h1>(e.g. on system shutdown).</h1>

<p>IPTABLES_SAVE_ON_STOP=&ldquo;yes&rdquo;</p>

<h1>Save current firewall rules on restart.</h1>

<h1>Value: yes|no,  default: no</h1>

<h1>Saves all firewall rules to /etc/sysconfig/iptables if firewall gets</h1>

<h1>restarted.</h1>

<p>IPTABLES_SAVE_ON_RESTART=&ldquo;yes&rdquo;
```</p>

<p>Finally, I was able to save the changes and checked that they persisted after reboot:</p>

<p><code>plain
service iptables save
iptables: Saving firewall rules to /etc/sysconfig/iptables:[  OK  ]
</code></p>

<h4>Name-based vhosts</h4>

<p>We&rsquo;ve seen the virtual hosts running on different ports, now let&rsquo;s see how we can <strong>serve them on the same port, but with different names</strong>. I modified one of the config files so that both sites will run on port 80.Let&rsquo;s see the current virtual host settings:</p>

<p>``` plain
httpd -S
VirtualHost configuration:
*:80                   is a NameVirtualHost</p>

<pre><code>     default server myweb.local (/etc/httpd/conf.d/myweb.conf:1)
     port 80 namevhost myweb.local (/etc/httpd/conf.d/myweb.conf:1)
     port 80 namevhost skynet.local (/etc/httpd/conf.d/skynet.conf:1)
</code></pre>

<p>ServerRoot: &ldquo;/etc/httpd&rdquo;
Main DocumentRoot: &ldquo;/var/www/html&rdquo;
Main ErrorLog: &ldquo;/etc/httpd/logs/error_log&rdquo;
[snip]
```</p>

<p>We will use the server names to navigate to those sites. Because I am testing locally with no DNS, I modified <code>/etc/hosts</code> and added these entries:</p>

<p><code>plain
192.168.80.153 myweb.local
192.168.80.153 skynet.local
</code></p>

<p>Now I was able to use the names of the sites in the web browser.</p>

<h3>Password protection</h3>

<p>It&rsquo;s time to restrict access to the skynet website! There are a number of ways that Apache can protect a resource with a password and ensure that is accessible only to certain users. In this example, I will want the skynet website to allow only a user called tx. First, I used the <em>htpasswd</em> utility to create a <em>.htpasswd</em> file (you can call it whatever you want), and placed it in <code>/etc/httpd</code>.</p>

<p><code>plain
htpasswd -c /etc/httpd/.htpasswd tx
New password:
Re-type new password:
Adding password for user tx
</code></p>

<p>This file holds the allowed user/password combination:</p>

<p><code>plain
cat /etc/httpd/.htpasswd
tx:$apr1$2FI77JZQ$IrMFnxvHzvtRhWGiQfvxL0
</code></p>

<p>The next step is to tell Apache to restrict access to a resource based on this file. If you have access to the main configuration file or the virtual host config file, the preferred way is to add a Directory directive there:</p>

<p>``` plain
nano /etc/httpd/conf.d/skynet.conf
<VirtualHost *:80></p>

<pre><code>DocumentRoot "/var/www/html/skynet"
ServerName skynet.local
&lt;Directory "/var/www/html/skynet"&gt;
    AuthType Basic
    AuthName "Authorized Only"
    AuthUserFile /etc/httpd/.htpasswd
    Require valid-user
&lt;/Directory&gt;
</code></pre>

<p></VirtualHost></p>

<p>```</p>

<p>The Directory specified is the one that will be password-protected. Next, we specify the type of authentication (basic in this case, so no super sensitive files should be stored there), the name which will be displayed on the prompt, the location where Apache can find the password file, and the allowed user(s). Maybe we&rsquo;ll want to add some terminators later, so instead of just specifying one user, I allowed any valid user/password combination from the password file.</p>

<p>Now if you try to go to the skynet website, you will see the window prompting for username and password.</p>

<p>Another way you can restrict directory access is via a <strong>.htaccess</strong> file. Due to performance and security reasons, you should avoid this, if possible.</p>

<p>First, create a .htaccess file in the directory you want to protect:</p>

<p><code>plain
nano /var/www/html/skynet/.htaccess
AuthType Basic
AuthName "Authorized Only"
AuthUserFile /etc/httpd/.htpasswd
Require valid-user
</code></p>

<p>For the .htaccess file to work, you need to edit the <code>/etc/httpd/conf/httpd.conf</code> file, and change the <a href="https://httpd.apache.org/docs/current/mod/core.html#allowoverride">AllowOverride directive</a> inside Directory. When set to None, as it is by default, .htaccess files are ignored. Change it to AuthConfig (I had to do it both under /var/www and /var/www/html).</p>

<h3>HTTPS with self-signed certificate</h3>

<p>In the next demo, I will encrypt the skynet website with SSL (removed all the authorization bits for demo purposes).</p>

<p>First, I installed <a href="https://httpd.apache.org/docs/current/mod/mod_ssl.html">mod_ssl</a> with <code>yum install mod_ssl</code>. Next, I created a directory for Apache to store its server key and certificate: <code>mkdir /etc/httpd/myssl</code></p>

<p>Inside this directory, I created a RSA private key of length 2048:</p>

<p><code>plain
[root@freehat myssl]# openssl genrsa -out https.key 2048
Generating RSA private key, 2048 bit long modulus
....................+++
..............+++
e is 65537 (0x10001)
</code></p>

<p>Then I created a Certificate Signing Request (CSR):</p>

<p>``` plain
[root@freehat myssl]# openssl req -new -key https.key -out server.csr
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,</p>

<h2>If you enter &lsquo;.&rsquo;, the field will be left blank.</h2>

<p>Country Name (2 letter code) [XX]:
State or Province Name (full name) []:
Locality Name (eg, city) [Default City]:
Organization Name (eg, company) [Default Company Ltd]:
Organizational Unit Name (eg, section) []:
Common Name (eg, your name or your server&rsquo;s hostname) []:
Email Address []:</p>

<p>Please enter the following &lsquo;extra&rsquo; attributes
to be sent with your certificate request
A challenge password []:
An optional company name []:
```</p>

<p>Lastly, I generated an x509 certificate with a duration of an year:</p>

<p><code>plain
[root@freehat myssl]# openssl x509 -req -days 365 -in server.csr -signkey https.key -out mycert.crt
Signature ok
subject=/C=XX/L=Default City/O=Default Company Ltd
Getting Private key
</code></p>

<p>We&rsquo;re not done yet. Edit the file <code>/etc/httpd/conf.d/ssl.conf</code>, and comment the lines with the location of the server key and certificate, replacing them with new ones pointing at our previously created files:</p>

<p>``` plain</p>

<h1>SSLCertificateFile /etc/pki/tls/certs/localhost.crt</h1>

<p>SSLCertificateFile /etc/httpd/myssl/mycert.crt</p>

<h1>SSLCertificateKeyFile /etc/pki/tls/private/localhost.key</h1>

<p>SSLCertificateKeyFile /etc/httpd/myssl/https.key
```</p>

<p>Now restart the server and go to website (mine is at <a href="https://192.168.80.153/">https://192.168.80.153/</a> ). Your browser will warn you about the untrusted connection, add it to exceptions and now you have https on your site.</p>

<h3>Logging</h3>

<p>Lastly, let&rsquo;s go over Apache&rsquo;s logging system. There are 2 types of logs kept, error logs for when some error happens, and access logs, that provide information about incoming requests. By default, these logs are located at <code>/var/log/httpd/error_log</code> and <code>/var/log/httpd/access_log</code> on CentOS</p>

<p>For your sites, you can configure the logs and choose where to store them. I decided to separate the logs for my skynet website. I made a folder for them in /var/log/httpd/skynet-logs, and modified the skynet virtual host config file and added the path and format for the logs:</p>

<p><code>plain
CustomLog /var/log/httpd/skynet-logs/skynet-access.log combined
ErrorLog /var/log/httpd/skynet-logs/skynet-error.log
</code></p>

<p>I wanted the combined format instead of the common one, because it provides a bit more information, including also the User-agent and the Referer</p>

<p>Hopefully, this post has helped others in setting up an Apache web server. Since I&rsquo;ve installed it on CentOS 7, I also had to account for SELinux and some other differences from a Debian distro, so it&rsquo;s been a good learning experience.</p>

<p>If you want to become an Apache wizard, the <a href="https://httpd.apache.org/docs/2.4/">Apache 2.4 documentation</a> should be a good starting point.</p>

<p>``` plain</p>

<hr />

<p>/ Give thought to your reputation.       \
| Consider changing name and moving to a |
\ new town.                              /</p>

<hr />

<pre><code>    \   ^__^
     \  (oo)\_______
        (__)\       )\/\
            ||----w |
            ||     ||
</code></pre>

<p>```</p>

<p><strong>Freshly installed httpd.conf file</strong></p>

<p>``` plain
#</p>

<h1>This is the main Apache HTTP server configuration file.  It contains the</h1>

<h1>configuration directives that give the server its instructions.</h1>

<h1>See &lt;URL:<a href="http://httpd.apache.org/docs/2.4/">http://httpd.apache.org/docs/2.4/</a>> for detailed information.</h1>

<h1>In particular, see</h1>

<h1>&lt;URL:<a href="http://httpd.apache.org/docs/2.4/mod/directives.html">http://httpd.apache.org/docs/2.4/mod/directives.html</a>></h1>

<h1>for a discussion of each configuration directive.</h1>

<p>#</p>

<h1>Do NOT simply read the instructions in here without understanding</h1>

<h1>what they do.  They&rsquo;re here only as hints or reminders.  If you are unsure</h1>

<h1>consult the online docs. You have been warned.</h1>

<p>#</p>

<h1>Configuration and logfile names: If the filenames you specify for many</h1>

<h1>of the server&rsquo;s control files begin with &ldquo;/&rdquo; (or &ldquo;drive:/&rdquo; for Win32), the</h1>

<h1>server will use that explicit path.  If the filenames do <em>not</em> begin</h1>

<h1>with &ldquo;/&rdquo;, the value of ServerRoot is prepended &mdash; so &lsquo;log/access_log&rsquo;</h1>

<h1>with ServerRoot set to &lsquo;/www&rsquo; will be interpreted by the</h1>

<h1>server as &lsquo;/www/log/access_log&rsquo;, where as &lsquo;/log/access_log&rsquo; will be</h1>

<h1>interpreted as &lsquo;/log/access_log&rsquo;.</h1>

<p>#</p>

<h1>ServerRoot: The top of the directory tree under which the server&rsquo;s</h1>

<h1>configuration, error, and log files are kept.</h1>

<p>#</p>

<h1>Do not add a slash at the end of the directory path.  If you point</h1>

<h1>ServerRoot at a non-local disk, be sure to specify a local disk on the</h1>

<h1>Mutex directive, if file-based mutexes are used.  If you wish to share the</h1>

<h1>same ServerRoot for multiple httpd daemons, you will need to change at</h1>

<h1>least PidFile.</h1>

<p>#
ServerRoot &ldquo;/etc/httpd&rdquo;</p>

<p>#</p>

<h1>Listen: Allows you to bind Apache to specific IP addresses and/or</h1>

<h1>ports, instead of the default. See also the <VirtualHost></h1>

<h1>directive.</h1>

<p>#</p>

<h1>Change this to Listen on specific IP addresses as shown below to</h1>

<h1>prevent Apache from glomming onto all bound IP addresses.</h1>

<p>#</p>

<h1>Listen 12.34.56.78:80</h1>

<p>Listen 80</p>

<p>#</p>

<h1>Dynamic Shared Object (DSO) Support</h1>

<p>#</p>

<h1>To be able to use the functionality of a module which was built as a DSO you</h1>

<h1>have to place corresponding `LoadModule' lines at this location so the</h1>

<h1>directives contained in it are actually available <em>before</em> they are used.</h1>

<h1>Statically compiled modules (those listed by `httpd -l') do not need</h1>

<h1>to be loaded here.</h1>

<p>#</p>

<h1>Example:</h1>

<h1>LoadModule foo_module modules/mod_foo.so</h1>

<p>#
Include conf.modules.d/*.conf</p>

<p>#</p>

<h1>If you wish httpd to run as a different user or group, you must run</h1>

<h1>httpd as root initially and it will switch.</h1>

<p>#</p>

<h1>User/Group: The name (or #number) of the user/group to run httpd as.</h1>

<h1>It is usually good practice to create a dedicated user and group for</h1>

<h1>running httpd, as with most system services.</h1>

<p>#
User apache
Group apache</p>

<h1>&lsquo;Main&rsquo; server configuration</h1>

<p>#</p>

<h1>The directives in this section set up the values used by the &lsquo;main&rsquo;</h1>

<h1>server, which responds to any requests that aren&rsquo;t handled by a</h1>

<h1><VirtualHost> definition.  These values also provide defaults for</h1>

<h1>any <VirtualHost> containers you may define later in the file.</h1>

<p>#</p>

<h1>All of these directives may appear inside <VirtualHost> containers,</h1>

<h1>in which case these default settings will be overridden for the</h1>

<h1>virtual host being defined.</h1>

<p>#</p>

<p>#</p>

<h1>ServerAdmin: Your address, where problems with the server should be</h1>

<h1>e-mailed.  This address appears on some server-generated pages, such</h1>

<h1>as error documents.  e.g. <a href="&#x6d;&#97;&#105;&#108;&#116;&#111;&#x3a;&#97;&#100;&#109;&#x69;&#110;&#x40;&#121;&#x6f;&#117;&#114;&#45;&#x64;&#111;&#x6d;&#x61;&#105;&#110;&#46;&#99;&#111;&#x6d;">&#97;&#100;&#x6d;&#x69;&#x6e;&#x40;&#121;&#x6f;&#117;&#x72;&#x2d;&#100;&#x6f;&#x6d;&#x61;&#x69;&#x6e;&#46;&#x63;&#111;&#109;</a></h1>

<p>#
ServerAdmin root@localhost</p>

<p>#</p>

<h1>ServerName gives the name and port that the server uses to identify itself.</h1>

<h1>This can often be determined automatically, but we recommend you specify</h1>

<h1>it explicitly to prevent problems during startup.</h1>

<p>#</p>

<h1>If your host doesn&rsquo;t have a registered DNS name, enter its IP address here.</h1>

<p>#</p>

<h1>ServerName www.example.com:80</h1>

<p>#</p>

<h1>Deny access to the entirety of your server&rsquo;s filesystem. You must</h1>

<h1>explicitly permit access to web content directories in other</h1>

<h1><Directory> blocks below.</h1>

<p>#
<Directory /></p>

<pre><code>AllowOverride none
Require all denied
</code></pre>

<p></Directory></p>

<p>#</p>

<h1>Note that from this point forward you must specifically allow</h1>

<h1>particular features to be enabled &ndash; so if something&rsquo;s not working as</h1>

<h1>you might expect, make sure that you have specifically enabled it</h1>

<h1>below.</h1>

<p>#</p>

<p>#</p>

<h1>DocumentRoot: The directory out of which you will serve your</h1>

<h1>documents. By default, all requests are taken from this directory, but</h1>

<h1>symbolic links and aliases may be used to point to other locations.</h1>

<p>#
DocumentRoot &ldquo;/var/www/html&rdquo;</p>

<p>#</p>

<h1>Relax access to content within /var/www.</h1>

<p>#
<Directory "/var/www"></p>

<pre><code>AllowOverride None
# Allow open access:
Require all granted
</code></pre>

<p></Directory></p>

<h1>Further relax access to the default document root:</h1>

<p><Directory "/var/www/html"></p>

<pre><code>#
# Possible values for the Options directive are "None", "All",
# or any combination of:
#   Indexes Includes FollowSymLinks SymLinksifOwnerMatch ExecCGI MultiViews
#
# Note that "MultiViews" must be named *explicitly* --- "Options All"
# doesn't give it to you.
#
# The Options directive is both complicated and important.  Please see
# http://httpd.apache.org/docs/2.4/mod/core.html#options
# for more information.
#
Options Indexes FollowSymLinks

#
# AllowOverride controls what directives may be placed in .htaccess files.
# It can be "All", "None", or any combination of the keywords:
#   Options FileInfo AuthConfig Limit
#
AllowOverride None

#
# Controls who can get stuff from this server.
#
Require all granted
</code></pre>

<p></Directory></p>

<p>#</p>

<h1>DirectoryIndex: sets the file that Apache will serve if a directory</h1>

<h1>is requested.</h1>

<p>#
<IfModule dir_module></p>

<pre><code>DirectoryIndex index.html
</code></pre>

<p></IfModule></p>

<p>#</p>

<h1>The following lines prevent .htaccess and .htpasswd files from being</h1>

<h1>viewed by Web clients.</h1>

<p>#
<Files ".ht*"></p>

<pre><code>Require all denied
</code></pre>

<p></Files></p>

<p>#</p>

<h1>ErrorLog: The location of the error log file.</h1>

<h1>If you do not specify an ErrorLog directive within a <VirtualHost></h1>

<h1>container, error messages relating to that virtual host will be</h1>

<h1>logged here.  If you <em>do</em> define an error logfile for a <VirtualHost></h1>

<h1>container, that host&rsquo;s errors will be logged there and not here.</h1>

<p>#
ErrorLog &ldquo;logs/error_log&rdquo;</p>

<p>#</p>

<h1>LogLevel: Control the number of messages logged to the error_log.</h1>

<h1>Possible values include: debug, info, notice, warn, error, crit,</h1>

<h1>alert, emerg.</h1>

<p>#
LogLevel warn</p>

<p><IfModule log_config_module></p>

<pre><code>#
# The following directives define some format nicknames for use with
# a CustomLog directive (see below).
#
LogFormat "%h %l %u %t \"%r\" %&gt;s %b \"%{Referer}i\" \"%{User-Agent}i\"" combined
LogFormat "%h %l %u %t \"%r\" %&gt;s %b" common

&lt;IfModule logio_module&gt;
  # You need to enable mod_logio.c to use %I and %O
  LogFormat "%h %l %u %t \"%r\" %&gt;s %b \"%{Referer}i\" \"%{User-Agent}i\" %I %O" combinedio
&lt;/IfModule&gt;

#
# The location and format of the access logfile (Common Logfile Format).
# If you do not define any access logfiles within a &lt;VirtualHost&gt;
# container, they will be logged here.  Contrariwise, if you *do*
# define per-&lt;VirtualHost&gt; access logfiles, transactions will be
# logged therein and *not* in this file.
#
#CustomLog "logs/access_log" common

#
# If you prefer a logfile with access, agent, and referer information
# (Combined Logfile Format) you can use the following directive.
#
CustomLog "logs/access_log" combined
</code></pre>

<p></IfModule></p>

<p><IfModule alias_module></p>

<pre><code>#
# Redirect: Allows you to tell clients about documents that used to 
# exist in your server's namespace, but do not anymore. The client 
# will make a new request for the document at its new location.
# Example:
# Redirect permanent /foo http://www.example.com/bar

#
# Alias: Maps web paths into filesystem paths and is used to
# access content that does not live under the DocumentRoot.
# Example:
# Alias /webpath /full/filesystem/path
#
# If you include a trailing / on /webpath then the server will
# require it to be present in the URL.  You will also likely
# need to provide a &lt;Directory&gt; section to allow access to
# the filesystem path.

#
# ScriptAlias: This controls which directories contain server scripts. 
# ScriptAliases are essentially the same as Aliases, except that
# documents in the target directory are treated as applications and
# run by the server when requested rather than as documents sent to the
# client.  The same rules about trailing "/" apply to ScriptAlias
# directives as to Alias.
#
ScriptAlias /cgi-bin/ "/var/www/cgi-bin/"
</code></pre>

<p></IfModule></p>

<p>#</p>

<h1>&ldquo;/var/www/cgi-bin&rdquo; should be changed to whatever your ScriptAliased</h1>

<h1>CGI directory exists, if you have that configured.</h1>

<p>#
<Directory "/var/www/cgi-bin"></p>

<pre><code>AllowOverride None
Options None
Require all granted
</code></pre>

<p></Directory></p>

<p><IfModule mime_module></p>

<pre><code>#
# TypesConfig points to the file containing the list of mappings from
# filename extension to MIME-type.
#
TypesConfig /etc/mime.types

#
# AddType allows you to add to or override the MIME configuration
# file specified in TypesConfig for specific file types.
#
#AddType application/x-gzip .tgz
#
# AddEncoding allows you to have certain browsers uncompress
# information on the fly. Note: Not all browsers support this.
#
#AddEncoding x-compress .Z
#AddEncoding x-gzip .gz .tgz
#
# If the AddEncoding directives above are commented-out, then you
# probably should define those extensions to indicate media types:
#
AddType application/x-compress .Z
AddType application/x-gzip .gz .tgz

#
# AddHandler allows you to map certain file extensions to "handlers":
# actions unrelated to filetype. These can be either built into the server
# or added with the Action directive (see below)
#
# To use CGI scripts outside of ScriptAliased directories:
# (You will also need to add "ExecCGI" to the "Options" directive.)
#
#AddHandler cgi-script .cgi

# For type maps (negotiated resources):
#AddHandler type-map var

#
# Filters allow you to process content before it is sent to the client.
#
# To parse .shtml files for server-side includes (SSI):
# (You will also need to add "Includes" to the "Options" directive.)
#
AddType text/html .shtml
AddOutputFilter INCLUDES .shtml
</code></pre>

<p></IfModule></p>

<p>#</p>

<h1>Specify a default charset for all content served; this enables</h1>

<h1>interpretation of all content as UTF-8 by default.  To use the</h1>

<h1>default browser choice (ISO-8859-1), or to allow the META tags</h1>

<h1>in HTML content to override this choice, comment out this</h1>

<h1>directive:</h1>

<p>#
AddDefaultCharset UTF-8</p>

<p><IfModule mime_magic_module></p>

<pre><code>#
# The mod_mime_magic module allows the server to use various hints from the
# contents of the file itself to determine its type.  The MIMEMagicFile
# directive tells the module where the hint definitions are located.
#
MIMEMagicFile conf/magic
</code></pre>

<p></IfModule></p>

<p>#</p>

<h1>Customizable error responses come in three flavors:</h1>

<h1>1) plain text 2) local redirects 3) external redirects</h1>

<p>#</p>

<h1>Some examples:</h1>

<h1>ErrorDocument 500 &ldquo;The server made a boo boo.&rdquo;</h1>

<h1>ErrorDocument 404 /missing.html</h1>

<h1>ErrorDocument 404 &ldquo;/cgi-bin/missing_handler.pl&rdquo;</h1>

<h1>ErrorDocument 402 <a href="http://www.example.com/subscription_info.html">http://www.example.com/subscription_info.html</a></h1>

<p>#</p>

<p>#</p>

<h1>EnableMMAP and EnableSendfile: On systems that support it,</h1>

<h1>memory-mapping or the sendfile syscall may be used to deliver</h1>

<h1>files.  This usually improves server performance, but must</h1>

<h1>be turned off when serving from networked-mounted</h1>

<h1>filesystems or if support for these functions is otherwise</h1>

<h1>broken on your system.</h1>

<h1>Defaults if commented: EnableMMAP On, EnableSendfile Off</h1>

<p>#</p>

<h1>EnableMMAP off</h1>

<p>EnableSendfile on</p>

<h1>Supplemental configuration</h1>

<p>#</p>

<h1>Load config files in the &ldquo;/etc/httpd/conf.d&rdquo; directory, if any.</h1>

<p>IncludeOptional conf.d/*.conf
```</p>

<p><strong>apachectl utility</strong></p>

<p>``` plain
APACHECTL(8)                 apachectl                APACHECTL(8)</p>

<p>NAME</p>

<pre><code>   apachectl - Apache HTTP Server Control Interface
</code></pre>

<p>SYNOPSIS</p>

<pre><code>   When  acting  in  pass-through  mode,  apachectl can take all the arguments
   available for the httpd binary.


   apachectl [ httpd-argument ]


   When acting in SysV init mode, apachectl takes simple,  one-word  commands,
   defined below.


   apachectl command
</code></pre>

<p>SUMMARY</p>

<pre><code>   apachectl  is  a front end to the Apache HyperText Transfer Protocol (HTTP)
   server. It is designed to help the administrator control the functioning of
   the Apache httpd daemon.


   The  apachectl script can operate in two modes. First, it can act as a sim‐
   ple front-end to the httpd command that simply sets any necessary  environ‐
   ment  variables  and  then  invokes httpd, passing through any command line
   arguments. Second, apachectl can act as a SysV init script,  taking  simple
   one-word arguments like start, restart, and stop, and translating them into
   appropriate signals to httpd.


   If your Apache installation uses non-standard paths, you will need to  edit
   the  apachectl script to set the appropriate paths to the httpd binary. You
   can also specify any necessary httpd command line arguments. See  the  com‐
   ments in the script for details.


   The  apachectl script returns a 0 exit value on success, and &gt;0 if an error
   occurs. For more details, view the comments in the script.
</code></pre>

<p>OPTIONS</p>

<pre><code>   Only the SysV init-style options are  defined  here.  Other  arguments  are
   defined on the httpd manual page.



   start  Start  the Apache httpd daemon. Gives an error if it is already run‐
      ning. This is equivalent to apachectl -k start.

   stop   Stops the Apache httpd daemon. This is equivalent  to  apachectl  -k
      stop.

   restart
      Restarts  the  Apache httpd daemon. If the daemon is not running, it
      is started. This  command  automatically  checks  the  configuration
      files  as  in  configtest before initiating the restart to make sure
      the daemon doesn't die. This is equivalent to apachectl -k restart.

   fullstatus
      Displays a full status report from mod_status. For this to work, you
      need  to  have  mod_status  enabled  on your server and a text-based
      browser such as lynx available on  your  system.  The  URL  used  to
      access  the  status report can be set by editing the STATUSURL vari‐
      able in the script.

   status Displays a brief status report using systemd.

   graceful
      Gracefully restarts the Apache httpd daemon. If the  daemon  is  not
      running,  it  is  not started. This differs from a normal restart in
      that currently open connections are not aborted. A  side  effect  is
      that  old  log files will not be closed immediately. This means that
      if used in a log rotation script, a substantial delay may be  neces‐
      sary  to  ensure that the old log files are closed before processing
      them. This command automatically checks the configuration  files  as
      in  configtest  before  initiating  the  restart to make sure Apache
      doesn't die. This is equivalent to apachectl -k graceful.

   graceful-stop
      Gracefully stops the Apache httpd daemon. This differs from a normal
      stop  in  that  currently  open  connections are not aborted. A side
      effect is that old log files will not be closed immediately. This is
      equivalent to apachectl -k graceful-stop.

   configtest
      Run  a  configuration  file syntax test. It parses the configuration
      files and either reports Syntax Ok or detailed information about the
      particular syntax error. This is equivalent to apachectl -t.


   The  following  option  was  available  in  earlier  versions  but has been
   removed.



   startssl
      To start httpd with SSL support, you should edit your  configuration
      file  to  include  the  relevant  directives and then use the normal
      apachectl start.
</code></pre>

<p>Apache HTTP Server          2005-08-26                APACHECTL(8)
```</p>

<p><strong>httpd reference</strong></p>

<p>``` plain
HTTPD(8)                   httpd                  HTTPD(8)</p>

<p>NAME</p>

<pre><code>   httpd - Apache Hypertext Transfer Protocol Server
</code></pre>

<p>SYNOPSIS</p>

<pre><code>   httpd  [  -d serverroot ] [ -f config ] [ -C directive ] [ -c directive ] [
   -D parameter ] [  -e  level  ]  [  -E  file  ]  [  -k  start|restart|grace‐
   ful|stop|graceful-stop  ] [ -R directory ] [ -h ] [ -l ] [ -L ] [ -S ] [ -t
   ] [ -v ] [ -V ] [ -X ] [ -M ] [ -T ]


   On Windows systems, the following additional arguments are available:


   httpd [ -k install|config|uninstall ] [ -n name ] [ -w ]
</code></pre>

<p>SUMMARY</p>

<pre><code>   httpd is the Apache HyperText Transfer Protocol (HTTP) server  program.  It
   is  designed  to be run as a standalone daemon process. When used like this
   it will create a pool of child processes or threads to handle requests.


   In general, httpd should not be invoked  directly,  but  rather  should  be
   invoked  via apachectl on Unix-based systems or as a service on Windows NT,
   2000 and XP and as a console application on Windows 9x and ME.
</code></pre>

<p>OPTIONS</p>

<pre><code>   -d serverroot
      Set the initial value for the ServerRoot  directive  to  serverroot.
      This can be overridden by the ServerRoot directive in the configura‐
      tion file. The default is /etc/httpd.

   -f config
      Uses the directives in the file config on startup.  If  config  does
      not  begin  with  a /, then it is taken to be a path relative to the
      ServerRoot. The default is conf/httpd.conf.

   -k start|restart|graceful|stop|graceful-stop
      Signals httpd to start, restart, or stop. See Stopping Apache  httpd
      for more information.

   -C directive
      Process the configuration directive before reading config files.

   -c directive
      Process the configuration directive after reading config files.

   -D parameter
      Sets  a  configuration  parameter  which can be used with &lt;IfDefine&gt;
      sections in the configuration files to conditionally skip or process
      commands at server startup and restart. Also can be used to set cer‐
      tain less-common startup parameters including  -DNO_DETACH  (prevent
      the  parent  from forking) and -DFOREGROUND (prevent the parent from
      calling setsid() et al).

   -e level
      Sets the LogLevel to level during server startup. This is useful for
      temporarily  increasing  the verbosity of the error messages to find
      problems during startup.

   -E file
      Send error messages during server startup to file.

   -h     Output a short summary of available command line options.

   -l     Output a list of modules compiled into the  server.  This  will  not
      list dynamically loaded modules included using the LoadModule direc‐
      tive.

   -L     Output a list of directives provided  by  static  modules,  together
      with  expected  arguments  and  places where the directive is valid.
      Directives provided by shared modules are not listed.

   -M     Dump a list of loaded Static and Shared Modules.

   -S     Show the settings as parsed from the  config  file  (currently  only
      shows the virtualhost settings).

   -T (Available in 2.3.8 and later)
      Skip document root check at startup/restart.

   -t     Run  syntax  tests for configuration files only. The program immedi‐
      ately exits after these syntax parsing tests with  either  a  return
      code  of 0 (Syntax OK) or return code not equal to 0 (Syntax Error).
      If -D DUMP_VHOSTS is also set, details of the virtual host  configu‐
      ration  will be printed. If -D DUMP_MODULES  is set, all loaded mod‐
      ules will be printed.

   -v     Print the version of httpd, and then exit.

   -V     Print the version and build parameters of httpd, and then exit.

   -X     Run httpd in debug mode. Only one worker will  be  started  and  the
      server will not detach from the console.


   The following arguments are available only on the Windows platform:



   -k install|config|uninstall
      Install Apache httpd as a Windows NT service; change startup options
      for the Apache httpd service; and uninstall the  Apache  httpd  ser‐
      vice.

   -n name
      The name of the Apache httpd service to signal.

   -w     Keep  the console window open on error so that the error message can
      be read.
</code></pre>

<p>Apache HTTP Server          2012-02-10                HTTPD(8)
```</p>
]]></content>
  </entry>
  
</feed>
