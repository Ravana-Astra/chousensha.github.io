<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: linux | Core dump overflow]]></title>
  <link href="http://chousensha.github.io/blog/categories/linux/atom.xml" rel="self"/>
  <link href="http://chousensha.github.io/"/>
  <updated>2018-02-22T13:45:07-05:00</updated>
  <id>http://chousensha.github.io/</id>
  <author>
    <name><![CDATA[chousensha]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[LFCS prep - Software RAID]]></title>
    <link href="http://chousensha.github.io/blog/2018/02/22/lfcs-prep-software-raid/"/>
    <updated>2018-02-22T13:37:45-05:00</updated>
    <id>http://chousensha.github.io/blog/2018/02/22/lfcs-prep-software-raid</id>
    <content type="html"><![CDATA[<p>Today we&rsquo;ll look at creating software RAID devices with <em>mdadm</em>. For the example I will use /dev/sdb1 and /dev/sdb2</p>

<!-- more -->


<p>To create an array:</p>

<p>```
mdadm &mdash;create &mdash;verbose /dev/md0 &mdash;level=mirror &mdash;raid-devices=2 /dev/sdb1 /dev/sdb2
mdadm: /dev/sdb1 appears to be part of a raid array:</p>

<pre><code>   level=raid0 devices=0 ctime=Thu Jan  1 09:00:00 1970
</code></pre>

<p>mdadm: partition table exists on /dev/sdb1 but will be lost or</p>

<pre><code>   meaningless after creating array
</code></pre>

<p>mdadm: Note: this array has metadata at the start and</p>

<pre><code>may not be suitable as a boot device.  If you plan to
store '/boot' on this device please ensure that
your boot-loader understands md/v1.x metadata, or use
--metadata=0.90
</code></pre>

<p>mdadm: size set to 102272K
Continue creating array? y
mdadm: Defaulting to version 1.2 metadata
mdadm: array /dev/md0 started.</p>

<p>```</p>

<p>To view more information about the array:</p>

<p>```
cat /proc/mdstat
Personalities : [raid1]
md0 : active raid1 sdb2[1] sdb1[0]</p>

<pre><code>  102272 blocks super 1.2 [2/2] [UU]
</code></pre>

<p>unused devices: <none>
```</p>

<p>For more detailed information:</p>

<p>```
mdadm &mdash;detail /dev/md0
/dev/md0:</p>

<pre><code>    Version : 1.2
</code></pre>

<p>  Creation Time : Tue Feb 20 00:17:49 2018</p>

<pre><code> Raid Level : raid1
 Array Size : 102272 (99.88 MiB 104.73 MB)
</code></pre>

<p>  Used Dev Size : 102272 (99.88 MiB 104.73 MB)
   Raid Devices : 2
  Total Devices : 2</p>

<pre><code>Persistence : Superblock is persistent

Update Time : Tue Feb 20 00:17:53 2018
      State : clean 
</code></pre>

<p> Active Devices : 2
Working Devices : 2
 Failed Devices : 0
  Spare Devices : 0</p>

<pre><code>       Name : rhel7:0  (local to host rhel7)
       UUID : a92e04f3:1652f291:8c68266d:6c760648
     Events : 17

Number   Major   Minor   RaidDevice State
   0       8       17        0      active sync   /dev/sdb1
   1       8       18        1      active sync   /dev/sdb2
</code></pre>

<p>```</p>

<p>Now format the RAID device:</p>

<p><code>
mkfs.ext4 /dev/md0
</code></p>

<p>You need to create the config file <code>/etc/mdadm.conf</code> and add to it the output of the below command:</p>

<p><code>
mdadm --detail --scan
ARRAY /dev/md0 metadata=1.2 name=rhel7:0 UUID=a92e04f3:1652f291:8c68266d:6c760648
</code></p>

<p>See more information about the array disks:</p>

<p>```
mdadm &mdash;examine /dev/sdb1
/dev/sdb1:</p>

<pre><code>      Magic : a92b4efc
    Version : 1.2
Feature Map : 0x0
 Array UUID : a92e04f3:1652f291:8c68266d:6c760648
       Name : rhel7:0  (local to host rhel7)
</code></pre>

<p>  Creation Time : Tue Feb 20 00:17:49 2018</p>

<pre><code> Raid Level : raid1
</code></pre>

<p>   Raid Devices : 2</p>

<p> Avail Dev Size : 204640 (99.92 MiB 104.78 MB)</p>

<pre><code> Array Size : 102272 (99.88 MiB 104.73 MB)
</code></pre>

<p>  Used Dev Size : 204544 (99.88 MiB 104.73 MB)</p>

<pre><code>Data Offset : 160 sectors
</code></pre>

<p>   Super Offset : 8 sectors
   Unused Space : before=72 sectors, after=96 sectors</p>

<pre><code>      State : clean
Device UUID : 109087ab:0f2121e6:b6e09819:ffba2648

Update Time : Tue Feb 20 00:22:17 2018
</code></pre>

<p>  Bad Block Log : 512 entries available at offset 72 sectors</p>

<pre><code>   Checksum : f832b421 - correct
     Events : 17
</code></pre>

<p>   Device Role : Active device 0
   Array State : AA (&lsquo;A&rsquo; == active, &lsquo;.&rsquo; == missing, &lsquo;R&rsquo; == replacing)
```</p>

<p>Mount the array and check it:</p>

<p><code>
df -h /dev/md0
Filesystem      Size  Used Avail Use% Mounted on
/dev/md0         93M  1.6M   85M   2% /mnt/raid
</code></p>

<p>Other useful commands:</p>

<ul>
<li>assemble array</li>
</ul>


<p><code>
mdadm --assemble /dev/md0
</code></p>

<ul>
<li>remove disk from array (you have to mark it as failing first)</li>
</ul>


<p><code>
mdadm --fail /dev/md0 /dev/sdb2
mdadm --remove /dev/md0 /dev/sdb2
</code></p>

<ul>
<li>add disk to array</li>
</ul>


<p><code>
mdadm --add /dev/md0 /dev/sdb2
</code></p>

<ul>
<li>remove array</li>
</ul>


<p><code>
mdadm --stop /dev/md0
mdadm --remove /dev/md0
</code></p>

<p>```</p>

<hr />

<p>/ Don&rsquo;t relax! It&rsquo;s only your tension \
\ that&rsquo;s holding you together.        /</p>

<hr />

<pre><code>    \   ^__^
     \  (oo)\_______
        (__)\       )\/\
            ||----w |
            ||     ||
</code></pre>

<p>```</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[LFCS prep - Configure an IMAP service]]></title>
    <link href="http://chousensha.github.io/blog/2018/02/19/lfcs-prep-configure-an-imap-service/"/>
    <updated>2018-02-19T12:49:18-05:00</updated>
    <id>http://chousensha.github.io/blog/2018/02/19/lfcs-prep-configure-an-imap-service</id>
    <content type="html"><![CDATA[<p>Today we continue with the IMAP/S of LFCS, by configuring Dovecot.</p>

<p><a href="https://www.dovecot.org/">Dovecot</a> is an open source IMAP / POP3 server written with security in mind. It can be installed on CentOS via the <em>dovecot</em> package.</p>

<!-- more -->


<p>Inside the <code>/etc/dovecot.conf</code> file you have to add / edit some settings:</p>

<p><code>
protocols = imap pop3
</code></p>

<p>The above also include the secure versions of IMAPS and POP3 secure.</p>

<p>Next you have to edit the mailbox and namespace file <code>/etc/dovecot/conf.d/10-mail.conf</code>:</p>

<p><code>
mail_location = mbox:~/mail:INBOX=/var/mail/%u
mail_privileged_group = mail
</code></p>

<p>These will set the mailbox location to <em>/var/mail/username</em> and will set the group to <em>mail</em> for privileged operations.</p>

<p>Inside <code>/etc/dovecot/conf.d/10-ssl.conf</code> ensure that the below lines are uncommented:</p>

<p><code>
ssl_cert = &lt;/etc/pki/dovecot/certs/dovecot.pem
ssl_key = &lt;/etc/pki/dovecot/private/dovecot.pem
</code></p>

<p>Dump the non-default settings if you want an overview of Dovecot&rsquo;s settings:</p>

<p>```
dovecot -n</p>

<h1>2.2.10: /etc/dovecot/dovecot.conf</h1>

<h1>OS: Linux 3.10.0-514.21.1.el7.x86_64 x86_64 CentOS Linux release 7.3.1611 (Core)</h1>

<p>first_valid_uid = 1000
mail_location = mbox:~/mail:INBOX=/var/mail/%u
mail_privileged_group = mail
mbox_write_locks = fcntl
namespace inbox {
  inbox = yes
  location =
  mailbox Drafts {</p>

<pre><code>special_use = \Drafts
</code></pre>

<p>  }
  mailbox Junk {</p>

<pre><code>special_use = \Junk
</code></pre>

<p>  }
  mailbox Sent {</p>

<pre><code>special_use = \Sent
</code></pre>

<p>  }
  mailbox &ldquo;Sent Messages&rdquo; {</p>

<pre><code>special_use = \Sent
</code></pre>

<p>  }
  mailbox Trash {</p>

<pre><code>special_use = \Trash
</code></pre>

<p>  }
  prefix =
}
passdb {
  driver = pam
}
protocols = imap pop3
ssl = required
ssl_cert = &lt;/etc/pki/dovecot/certs/dovecot.pem
ssl_key = &lt;/etc/pki/dovecot/private/dovecot.pem
userdb {
  driver = passwd
}
```</p>

<p>Start dovecot and check that it&rsquo;s listening on its ports:</p>

<p><code>
netstat -ltpn | grep dovecot
tcp        0      0 0.0.0.0:110             0.0.0.0:*               LISTEN      4629/dovecot        
tcp        0      0 0.0.0.0:143             0.0.0.0:*               LISTEN      4629/dovecot        
tcp        0      0 0.0.0.0:993             0.0.0.0:*               LISTEN      4629/dovecot        
tcp        0      0 0.0.0.0:995             0.0.0.0:*               LISTEN      4629/dovecot        
</code></p>

<p>Send a mail to a user:</p>

<p><code>
echo "Readme" | mail -s "README" nixhat@example.com
</code></p>

<p>The mail will be readable in <em>/var/mail/nixhat</em>. I installed the mutt client to view it:</p>

<p>```
i:Exit  &ndash;:PrevPg  <Space>:NextPg v:View Attachm.  d:Del  r:Reply  j:Next ?:Help
Date: Mon, 19 Feb 2018 19:35:30 +0200
From: root <a href="&#x6d;&#x61;&#x69;&#x6c;&#116;&#111;&#x3a;&#x72;&#x6f;&#x6f;&#x74;&#64;&#x65;&#x78;&#97;&#x6d;&#x70;&#108;&#101;&#x2e;&#99;&#x6f;&#109;">&#114;&#111;&#x6f;&#116;&#64;&#101;&#x78;&#x61;&#x6d;&#112;&#108;&#101;&#x2e;&#x63;&#111;&#109;</a>
To: <a href="&#109;&#x61;&#105;&#x6c;&#116;&#x6f;&#x3a;&#x6e;&#x69;&#x78;&#104;&#97;&#116;&#x40;&#x65;&#120;&#97;&#109;&#112;&#108;&#101;&#x2e;&#99;&#111;&#x6d;">&#110;&#105;&#120;&#x68;&#97;&#x74;&#64;&#x65;&#x78;&#x61;&#109;&#112;&#108;&#x65;&#x2e;&#x63;&#x6f;&#109;</a>
Subject: README
User-Agent: Heirloom mailx 12.5 7/5/10</p>

<p>Readme
```</p>

<p>```</p>

<hr />

<p>/ Avert misunderstanding by calm, poise, \
\ and balance.                           /</p>

<hr />

<pre><code>    \   ^__^
     \  (oo)\_______
        (__)\       )\/\
            ||----w |
            ||     ||
</code></pre>

<p>```</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[LFCS prep - Configure an SMTP mail service]]></title>
    <link href="http://chousensha.github.io/blog/2018/02/17/lfcs-prep-configure-an-smtp-mail-service/"/>
    <updated>2018-02-17T12:16:33-05:00</updated>
    <id>http://chousensha.github.io/blog/2018/02/17/lfcs-prep-configure-an-smtp-mail-service</id>
    <content type="html"><![CDATA[<p>Today we&rsquo;ll look at configuring a mail service for LFCS objectives. We&rsquo;ll use the Postfix implementation that already comes preinstalled  on CentOS.</p>

<!-- more -->


<p>The configuration file with all Postfix parameters is <code>/etc/postfix/main.cf</code> and it is massive. Instead of manually editing it, it&rsquo;s easier to use <strong>postconf</strong>. Without arguments, it displays all parameters. If given a parameter name, it will show that parameter&rsquo;s value, and with the <strong>-e</strong> flag it can modify parameters.</p>

<p>Another important file for mail configuration is <code>/etc/aliases</code>. If you want a mail destined to a user to be delivered to another user, you can set an alias:</p>

<p><code>
username: alias
</code></p>

<p>The alias will get the mails destined for the user. I&rsquo;ve added an alias on my system so that root&rsquo;s mail will be delivered to nixhat:</p>

<p><code>
root: nixhat
</code></p>

<p>After changing any alias settings, you have to refresh the alias DB with the command <code>postalias /etc/aliases</code></p>

<p>Now it&rsquo;s time to edit some parameters in order to setup a working mail configuration.</p>

<ul>
<li>The <strong>myorigin</strong> parameter specifies the domain that locally-posted mail appears to come from</li>
</ul>


<p>The default is to use the hostname for this, but I will change it to use just the domain (example.com in this case)</p>

<p><code>
postconf -e 'myorigin=$mydomain'
[root@centos ~]# postconf myorigin
myorigin = $mydomain
</code></p>

<ul>
<li>The <strong>inet_interfaces</strong> parameter specifies the network interface addresses that this mail system receives mail on</li>
</ul>


<p>Here I have mine listening on the Ethernet interface in addition to localhost:</p>

<p><code>
postconf inet_interfaces
inet_interfaces = 192.168.217.131, localhost
</code></p>

<ul>
<li>The <strong>relayhost</strong> parameter specifies the default host to send mail to when no entry is matched in the optional transport(5) table. When no relayhost is given, mail is routed directly to the destination. On an intranet, specify the organizational domain name. In the case of SMTP, specify a domain, host, host:port, [host]:port, [address] or [address]:port; the form [host] turns off MX lookups.</li>
</ul>


<p>If you want to forward mail to a central host, use the <strong>relayhost</strong> parameter</p>

<ul>
<li>The <strong>mydestination</strong> parameter specifies the list of domains that this machine considers itself the final destination for. This parameter is important for receiving messages</li>
</ul>


<p><code>
postconf mydestination
mydestination = $myhostname, localhost.$mydomain, localhost, $mydomain
</code></p>

<ul>
<li>The <strong>mynetworks</strong> parameter specifies the list of &ldquo;trusted&rdquo; SMTP clients that are allowed to relay mail through Postfix. It can allow clients on the local subnet, in a range, just a host, or manually specified.</li>
</ul>


<p><code>
postconf mynetworks
mynetworks = 192.168.217.0/24 127.0.0.0/8 [::1]/128
</code></p>

<h2>Restricting access to the server</h2>

<p>For receiving mail, you can add some settings to harden the security of your server:</p>

<ul>
<li><strong>smtpd_helo_required</strong> &ndash; Require that a remote SMTP client sends HELO or EHLO before commencing a MAIL transaction</li>
</ul>


<p><code>
postconf smtpd_helo_required
smtpd_helo_required = yes
</code></p>

<ul>
<li><strong>smtpd_helo_restrictions</strong> &ndash; other optional restrictions:</li>
</ul>


<p><strong>permit_mynetworks</strong> &ndash; Permit the request when the client IP address matches any network or network address listed in $mynetworks</p>

<p> <strong>reject_invalid_helo_hostname</strong> &ndash; Reject the request when the HELO or EHLO hostname is malformed</p>

<p><code>
postconf smtpd_helo_restrictions
smtpd_helo_restrictions = permit_mynetworks, reject_invalid_helo_hostname
</code></p>

<ul>
<li><strong>smtpd_sender_restrictions</strong> &ndash; Optional restrictions that the Postfix SMTP server applies in the context of a client MAIL FROM command:</li>
</ul>


<p><strong>reject_unknown_sender_domain</strong> &ndash; Reject the request when Postfix is not final destination for the sender address, and the MAIL FROM domain has 1) no DNS MX and no DNS A record, or 2) a malformed MX record such as a record with a zero-length MX hostname</p>

<p><code>
postconf smtpd_sender_restrictions
smtpd_sender_restrictions = permit_mynetworks, reject_unknown_sender_domain
</code></p>

<ul>
<li><strong>smtpd_recipient_restrictions</strong> &ndash; Optional restrictions that the Postfix SMTP server applies in the context of a client RCPT TO command</li>
</ul>


<p><strong>reject_unauth_destination</strong> &ndash; reject the request unless 1) Postfix is the mail forwarder; or 2) Postfix is the final destination</p>

<p><code>
postconf smtpd_recipient_restrictions
smtpd_recipient_restrictions = permit_mynetworks, reject_unauth_destination
</code></p>

<p>After changing Postfix settings, it is a good idea to run <code>postfix check</code> to check the validity of the config file. Then restart Postfix.</p>

<p>Now to test it:</p>

<p><code>
echo "This is a test" | mail -s "test" root@example.com
</code></p>

<p>On user nixhat:</p>

<p>```
mail
Heirloom Mail version 12.5 7/5/10.  Type ? for help.
&ldquo;/var/spool/mail/nixhat&rdquo;: 1 message 1 new</p>

<blockquote><p>N  1 root                  Sat Feb 17 18:08  18/569   &ldquo;test&rdquo;
cat  /var/spool/mail/nixhat
From <a href="&#x6d;&#x61;&#x69;&#x6c;&#x74;&#x6f;&#x3a;&#x72;&#111;&#111;&#x74;&#64;&#101;&#120;&#97;&#109;&#x70;&#x6c;&#x65;&#x2e;&#99;&#111;&#109;">&#114;&#x6f;&#111;&#116;&#64;&#101;&#x78;&#97;&#x6d;&#112;&#x6c;&#x65;&#x2e;&#x63;&#111;&#x6d;</a>  Sat Feb 17 18:08:09 2018
Return-Path: <a href="&#x6d;&#x61;&#105;&#x6c;&#x74;&#111;&#x3a;&#x72;&#111;&#111;&#x74;&#x40;&#x65;&#x78;&#97;&#x6d;&#112;&#108;&#x65;&#x2e;&#99;&#x6f;&#x6d;">&#114;&#x6f;&#x6f;&#x74;&#x40;&#101;&#x78;&#97;&#x6d;&#112;&#108;&#101;&#x2e;&#x63;&#x6f;&#x6d;</a>
X-Original-To: <a href="&#x6d;&#97;&#105;&#108;&#x74;&#x6f;&#58;&#114;&#111;&#x6f;&#116;&#x40;&#x65;&#x78;&#97;&#x6d;&#112;&#x6c;&#101;&#x2e;&#x63;&#111;&#x6d;">&#114;&#111;&#111;&#116;&#64;&#x65;&#120;&#x61;&#109;&#112;&#x6c;&#101;&#x2e;&#99;&#x6f;&#x6d;</a>
Delivered-To: <a href="&#109;&#97;&#x69;&#x6c;&#x74;&#111;&#58;&#x72;&#x6f;&#x6f;&#x74;&#64;&#x65;&#x78;&#97;&#x6d;&#112;&#108;&#101;&#46;&#x63;&#111;&#x6d;">&#x72;&#111;&#111;&#x74;&#x40;&#101;&#120;&#97;&#x6d;&#112;&#108;&#101;&#46;&#99;&#111;&#x6d;</a>
Received: by centos.example.com (Postfix, from userid 0)</p>

<pre><code>id 51255218FED7; Sat, 17 Feb 2018 18:08:09 +0200 (EET)
</code></pre>

<p>Date: Sat, 17 Feb 2018 18:08:09 +0200
To: <a href="&#x6d;&#97;&#105;&#108;&#x74;&#111;&#58;&#114;&#111;&#111;&#116;&#64;&#x65;&#120;&#x61;&#109;&#112;&#x6c;&#x65;&#x2e;&#x63;&#111;&#109;">&#114;&#111;&#111;&#x74;&#64;&#101;&#x78;&#x61;&#109;&#x70;&#108;&#101;&#46;&#99;&#111;&#x6d;</a>
Subject: test
User-Agent: Heirloom mailx 12.5 7/5/10
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Transfer-Encoding: 7bit
Message-Id: <a href="&#109;&#97;&#x69;&#108;&#x74;&#111;&#x3a;&#x32;&#48;&#49;&#56;&#48;&#x32;&#49;&#55;&#49;&#x36;&#48;&#x38;&#x30;&#57;&#46;&#x35;&#49;&#50;&#x35;&#53;&#50;&#x31;&#56;&#x46;&#x45;&#68;&#x37;&#x40;&#x63;&#x65;&#110;&#116;&#x6f;&#115;&#x2e;&#x65;&#x78;&#x61;&#x6d;&#x70;&#108;&#x65;&#46;&#99;&#111;&#x6d;">&#x32;&#48;&#x31;&#56;&#x30;&#x32;&#x31;&#x37;&#x31;&#54;&#48;&#56;&#x30;&#x39;&#x2e;&#x35;&#49;&#50;&#x35;&#x35;&#50;&#49;&#56;&#x46;&#69;&#x44;&#x37;&#64;&#x63;&#x65;&#x6e;&#116;&#x6f;&#115;&#46;&#101;&#120;&#x61;&#109;&#x70;&#x6c;&#101;&#x2e;&#99;&#x6f;&#109;</a>
From: <a href="&#x6d;&#x61;&#105;&#108;&#116;&#111;&#58;&#x72;&#111;&#111;&#116;&#x40;&#x65;&#x78;&#97;&#109;&#x70;&#x6c;&#x65;&#x2e;&#99;&#x6f;&#109;">&#114;&#111;&#x6f;&#116;&#x40;&#x65;&#x78;&#x61;&#109;&#x70;&#x6c;&#101;&#x2e;&#99;&#111;&#109;</a> (root)
Status: O</p></blockquote>

<p>This is a test
```</p>

<p>So it works. If you want to see more about the status of your mails, look inside <code>/var/log/maillog</code>:</p>

<p><code>
Feb 17 18:21:11 centos postfix/pickup[8896]: 4FADF218FED8: uid=0 from=&lt;root&gt;
Feb 17 18:21:11 centos postfix/cleanup[9359]: 4FADF218FED8: message-id=&lt;20180217162111.4FADF218FED8@centos.example.com&gt;
Feb 17 18:21:11 centos postfix/qmgr[8897]: 4FADF218FED8: from=&lt;root@example.com&gt;, size=431, nrcpt=1 (queue active)
Feb 17 18:21:11 centos postfix/local[9361]: 4FADF218FED8: to=&lt;nixhat@example.com&gt;, orig_to=&lt;root@example.com&gt;, relay=local, delay=0.08, delays=0.07/0.02/0/0, dsn=2.0.0, status=sent (delivered to mailbox)
Feb 17 18:21:11 centos postfix/qmgr[8897]: 4FADF218FED8: removed
</code></p>

<p>Some other useful actions with mail would be to view the mail queue with <strong>mailq</strong> and flush the queue with <strong>postfix flush</strong></p>

<p>Also see <strong>man 5 postconf</strong> for all Postfix parameters</p>

<p>```</p>

<hr />

<p>/ Q: What lies on the bottom of the ocean \
\ and twitches? A: A nervous wreck.       /</p>

<hr />

<pre><code>    \   ^__^
     \  (oo)\_______
        (__)\       )\/\
            ||----w |
            ||     ||
</code></pre>

<p>```</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[LFCS prep - Changing kernel parameters]]></title>
    <link href="http://chousensha.github.io/blog/2018/02/15/lfcs-prep-changing-kernel-parameters/"/>
    <updated>2018-02-15T13:28:47-05:00</updated>
    <id>http://chousensha.github.io/blog/2018/02/15/lfcs-prep-changing-kernel-parameters</id>
    <content type="html"><![CDATA[<p>In this post we&rsquo;ll look at changing kernel parameters both at runtime and at boot. Such changes can be made with the <strong>sysctl</strong> command or by inputting values in different files inside <code>/proc/sys</code></p>

<!-- more -->


<p>Let&rsquo;s see a sample /proc/sys folder, which can differ between systems:</p>

<p><code>
ls /proc/sys
abi  crypto  debug  dev  fs  kernel  net  sunrpc  vm
</code></p>

<p>The most important entries are:</p>

<ul>
<li><p>dev contains parameters for system devices</p></li>
<li><p>fs contains filesystem parameters</p></li>
<li><p>kernel is used for kernel parameters</p></li>
<li><p>net contains network parameters</p></li>
<li><p>vm contains virtual memory parameters</p></li>
</ul>


<p>To modify runtime parameters, we can use <strong>sysctl</strong>. Let&rsquo;s take a look at all the available parameters:</p>

<p><code>
sysctl -a | wc -l
951
</code></p>

<p>Too many to list here, so let&rsquo;s glance over a few random ipv4 parameters:</p>

<p><code>
sysctl -a | grep net.ipv4 | tail
net.ipv4.tcp_tso_win_divisor = 3
net.ipv4.tcp_tw_recycle = 0
net.ipv4.tcp_tw_reuse = 0
net.ipv4.tcp_window_scaling = 1
net.ipv4.tcp_wmem = 4096    16384    4194304
net.ipv4.tcp_workaround_signed_windows = 0
net.ipv4.udp_mem = 43428    57905    86856
net.ipv4.udp_rmem_min = 4096
net.ipv4.udp_wmem_min = 4096
net.ipv4.xfrm4_gc_thresh = 32768
</code></p>

<p>The dots in the options represent actual slashes in the directory structure under /proc/sys. Now let&rsquo;s take a value and modify it. I will use the packet forwarding feature for this example</p>

<p><code>
cat /proc/sys/net/ipv4/ip_forward
1
</code></p>

<p>So the system is configured to forward packets as a router. To change this, we can put a 0 value in the file:</p>

<p><code>
echo 0 &gt; /proc/sys/net/ipv4/ip_forward
</code></p>

<p>Another option is to write a value with sysctl. Here I enable IP forwarding again:</p>

<p><code>
sysctl -w net.ipv4.ip_forward=1
net.ipv4.ip_forward = 1
</code></p>

<p>Changes made in this way won&rsquo;t persist a reboot. To make them permanent, you have to edit the configuration file.
This used to be <code>/etc/sysctl.conf</code> , and can still be used, but newer systems look for config files inside <strong>/etc/sysctl.d/</strong>, <strong>/run/sysctl.d/</strong>, and <strong>/usr/lib/sysctl.d/</strong> (in order of precedence). On such systems, you can modify the <code>/usr/lib/sysctl.d/00-system</code> file for your kernel settings.</p>

<p>I edited mine to disable IP forwarding:</p>

<p>```</p>

<h1>Disable IP forwarding</h1>

<p>net.ipv4.ip_forward = 0
```</p>

<p>If you don&rsquo;t want to reboot, you can have sysctl re-read its config files by doing <strong>sysctl -p</strong> with the config file of your choice (by default, it will read <strong>/etc/sysctl.conf</strong>)</p>

<p><code>
 sysctl -p /usr/lib/sysctl.d/00-system.conf
net.ipv4.ip_forward = 0
cat /proc/sys/net/ipv4/ip_forward
0
</code></p>

<p>```</p>

<hr />

<p>/ You&rsquo;re definitely on their list. The \
| question to ask next is what list it |
\ is.                                  /</p>

<hr />

<pre><code>    \   ^__^
     \  (oo)\_______
        (__)\       )\/\
            ||----w |
            ||     ||
</code></pre>

<p>```</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[LFCS prep - NTP configuration]]></title>
    <link href="http://chousensha.github.io/blog/2018/02/14/lfcs-prep-ntp-configuration/"/>
    <updated>2018-02-14T14:50:41-05:00</updated>
    <id>http://chousensha.github.io/blog/2018/02/14/lfcs-prep-ntp-configuration</id>
    <content type="html"><![CDATA[<p>In this post we&rsquo;ll look at NTP configuration by using chrony, which is installed by default on newer RedHat systems.</p>

<!-- more -->


<p>Ensure that the <strong>chronyd</strong> service is started and let&rsquo;s take a look at the current time setttings:</p>

<p>```
timedatectl</p>

<pre><code>  Local time: Thu 2018-02-15 02:15:51 JST
</code></pre>

<p>  Universal time: Wed 2018-02-14 17:15:51 UTC</p>

<pre><code>    RTC time: Wed 2018-02-14 17:15:52
   Time zone: Asia/Tokyo (JST, +0900)
 NTP enabled: no
</code></pre>

<p>NTP synchronized: no
 RTC in local TZ: no</p>

<pre><code>  DST active: n/a
</code></pre>

<p>```</p>

<p>Now look inside chrony&rsquo;s config file, which is <code>/etc/chrony.conf</code>:</p>

<p>```</p>

<h1>Use public servers from the pool.ntp.org project.</h1>

<h1>Please consider joining the pool (<a href="http://www.pool.ntp.org/join.html">http://www.pool.ntp.org/join.html</a>).</h1>

<p>server 0.rhel.pool.ntp.org iburst
server 1.rhel.pool.ntp.org iburst
server 2.rhel.pool.ntp.org iburst
server 3.rhel.pool.ntp.org iburst</p>

<h1>Ignore stratum in source selection.</h1>

<p>stratumweight 0</p>

<h1>Record the rate at which the system clock gains/losses time.</h1>

<p>driftfile /var/lib/chrony/drift</p>

<h1>Enable kernel RTC synchronization.</h1>

<p>rtcsync</p>

<h1>In first three updates step the system clock instead of slew</h1>

<h1>if the adjustment is larger than 10 seconds.</h1>

<p>makestep 10 3</p>

<h1>Allow NTP client access from local network.</h1>

<h1>allow 192.168/16</h1>

<h1>Listen for commands only on localhost.</h1>

<p>bindcmdaddress 127.0.0.1
bindcmdaddress ::1</p>

<h1>Serve time even if not synchronized to any NTP server.</h1>

<h1>local stratum 10</h1>

<p>keyfile /etc/chrony.keys</p>

<h1>Specify the key used as password for chronyc.</h1>

<p>commandkey 1</p>

<h1>Generate command key if missing.</h1>

<p>generatecommandkey</p>

<h1>Disable logging of client accesses.</h1>

<p>noclientlog</p>

<h1>Send a message to syslog if a clock adjustment is larger than 0.5 seconds.</h1>

<p>logchange 0.5</p>

<p>logdir /var/log/chrony</p>

<h1>log measurements statistics tracking</h1>

<p>```</p>

<p>There is a set of default servers configured, but you can add your own. You can also allow NTP client access in the local network by uncommenting or adding the <strong>allow</strong> directive with a range.</p>

<p>In the previous timedatectl output we saw that NTP and synchronization weren&rsquo;t enabled, so let&rsquo;s enable them:</p>

<p>```
timedatectl set-ntp 1
timedatectl | grep -i ntp</p>

<pre><code> NTP enabled: yes
</code></pre>

<p>NTP synchronized: no
```</p>

<p>We still have to manage the NTP synchronization. In the config file we have some server pools enabled, but we want to know exact names for the servers:</p>

<p>```
chronyc sources -v
210 Number of sources = 4</p>

<p>  .&mdash; Source mode  &lsquo;^&rsquo; = server, &lsquo;=&rsquo; = peer, &lsquo;#&rsquo; = local clock.
 / .&ndash; Source state &lsquo;*&rsquo; = current synced, &lsquo;+&rsquo; = combined , &lsquo;&ndash;&rsquo; = not combined,
| /   &lsquo;?&rsquo; = unreachable, &lsquo;x&rsquo; = time may be in error, &lsquo;~&rsquo; = time too variable.
||                                                 .&ndash; xxxx [ yyyy ] +/&ndash; zzzz
||      Reachability register (octal) &ndash;.           |  xxxx = adjusted offset,
||      Log2(Polling interval) &mdash;.      |          |  yyyy = measured offset,
||                                \     |          |  zzzz = estimated error.
||                                 |    |           \</p>

<h1>MS Name/IP address         Stratum Poll Reach LastRx Last sample</h1>

<p>^? ts1.sct.de                    0   8     0   10y     +0ns[   +0ns] +/&ndash;    0ns
^? greenstone-quarry.the-jad     0   8     0   10y     +0ns[   +0ns] +/&ndash;    0ns
^? 1b.ncomputers.org             0   8     0   10y     +0ns[   +0ns] +/&ndash;    0ns
^? shout.ovh                     0   8     0   10y     +0ns[   +0ns] +/&ndash;    0ns
```</p>

<p>Now we can pick a server to synchronize with:</p>

<p>```
ntpdate -vd ts1.sct.de
15 Feb 02:37:52 ntpdate[9511]: ntpdate 4.2.6<a href="&#109;&#x61;&#105;&#x6c;&#116;&#x6f;&#x3a;&#112;&#53;&#64;&#x31;&#x2e;&#50;&#51;&#x34;&#57;&#45;&#111;">&#112;&#x35;&#x40;&#49;&#46;&#x32;&#x33;&#52;&#x39;&#45;&#111;</a> Wed Mar  1 09:00:52 UTC 2017 (1)
Looking for host ts1.sct.de and service ntp
host found : ts1.sct.de
transmit(193.141.27.1)
receive(193.141.27.1)
transmit(193.141.27.1)
receive(193.141.27.1)
transmit(193.141.27.1)
receive(193.141.27.1)
transmit(193.141.27.1)
receive(193.141.27.1)
server 193.141.27.1, port 123
stratum 2, precision -24, leap 00, trust 000
refid [193.141.27.1], delay 0.07736, dispersion 0.00209
transmitted 4, in filter 4
reference time:    de2ec48b.aba7efb5  Wed, Feb 14 2018 23:22:03.670
originate timestamp: de2ec847.3cbf5eb1  Wed, Feb 14 2018 23:37:59.237
transmit timestamp:  de2ef276.d94d8084  Thu, Feb 15 2018  2:37:58.848
filter delay:  0.07916  0.07736  0.08383  0.07954</p>

<pre><code>     0.00000  0.00000  0.00000  0.00000 
</code></pre>

<p>filter offset: -10799.6 -10799.6 -10799.6 -10799.6</p>

<pre><code>     0.000000 0.000000 0.000000 0.000000
</code></pre>

<p>delay 0.07736, dispersion 0.00209
offset -10799.642908</p>

<p>15 Feb 02:37:58 ntpdate[9511]: step time server 193.141.27.1 offset -10799.642908 sec
```</p>

<p>To get more information about the NTP status, check the tracking:</p>

<p><code>
chronyc tracking
Reference ID    : 193.141.27.1 (ts1.sct.de)
Stratum         : 3
Ref time (UTC)  : Wed Feb 14 14:41:11 2018
System time     : 0.000000000 seconds fast of NTP time
Last offset     : +10799.637695312 seconds
RMS offset      : 10799.637695312 seconds
Frequency       : 0.000 ppm fast
Residual freq   : -1.456 ppm
Skew            : 1000000.000 ppm
Root delay      : 0.069487 seconds
Root dispersion : 1528.844971 seconds
Update interval : 0.0 seconds
Leap status     : Normal
</code></p>

<p>You can see the server in the Reference ID and the Leap status that confirms the synchronization. Also re-check with timedatectl that NTP is working:</p>

<p>```
timedatectl | grep -i ntp</p>

<pre><code> NTP enabled: yes
</code></pre>

<p>NTP synchronized: yes
```</p>

<p>```</p>

<hr />

<p>/ Give thought to your reputation.       \
| Consider changing name and moving to a |
\ new town.                              /</p>

<hr />

<pre><code>    \   ^__^
     \  (oo)\_______
        (__)\       )\/\
            ||----w |
            ||     ||
</code></pre>

<p>```</p>
]]></content>
  </entry>
  
</feed>
